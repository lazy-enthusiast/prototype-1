<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº¬éƒ½ 2026 - ç¥‡åœ’ç¥­ç¨æ—… (æ™ºæ…§ç‰ˆ)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Shippori+Mincho:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #3E3C3A;       /* ç…¤ç«¹è‰² */
            --card-color: #E8E8E8;     /* ç°ç™½ */
            --accent-color: #E95464;   /* æœ±ç´… */
            --text-on-dark: #FFFFFB;   /* è±¡ç‰™ç™½ */
            --text-on-light: #2F2F2F;  /* å¢¨é»‘ */
            --menu-bg: #2b2a29;
            --weather-gradient: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
            --weather-gradient-hot: linear-gradient(135deg, #FF512F 0%, #DD2476 100%); /* å¤å¤©ç†±é…è‰² */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: "Noto Sans TC", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-on-dark);
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- Header --- */
        header {
            padding: 15px 20px;
            background-color: rgba(62, 60, 58, 0.98);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            height: 60px;
        }
        header h1 { margin: 0; font-size: 1.2rem; font-family: "Shippori Mincho", serif; letter-spacing: 1px; }
        
        .header-icons { display: flex; gap: 20px; align-items: center; }
        .header-btn { color: var(--text-on-dark); font-size: 1.2rem; cursor: pointer; text-decoration: none; position: relative;}
        .fan-btn i { color: var(--accent-color); }

        /* --- Date Selector --- */
        .date-selector-container {
            background: var(--bg-color); z-index: 90;
            padding: 10px 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            width: 100%;
        }
        .date-selector { 
            display: flex; 
            overflow-x: auto; 
            gap: 10px; 
            padding: 0 20px 5px 20px; 
            scrollbar-width: none; 
            -webkit-overflow-scrolling: touch;
            justify-content: flex-start;
        }
        @media (min-width: 768px) { .date-selector { justify-content: center; } }
        .date-selector::-webkit-scrollbar { display: none; }
        
        .date-chip {
            background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 16px;
            white-space: nowrap; font-size: 0.85rem; cursor: pointer; color: #aaa;
            display: flex; flex-direction: column; align-items: center; min-width: 55px;
            transition: all 0.2s; border: 1px solid transparent;
            flex-shrink: 0; 
        }
        .date-chip.active {
            background: var(--accent-color); color: #fff;
            box-shadow: 0 0 10px rgba(233, 84, 100, 0.4); transform: scale(1.05);
        }

        /* --- Main Content --- */
        main { flex: 1; overflow-y: hidden; position: relative; }

        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow-y: auto; padding: 10px 0 90px 0;
            display: none; opacity: 0; transition: opacity 0.3s ease;
            background-color: var(--bg-color);
            -webkit-overflow-scrolling: touch;
        }
        .page.active { display: block; opacity: 1; z-index: 10; }
        
        /* Map Page */
        #page-map { padding: 0 0 80px 0; } 
        #map-container { width: 100%; height: 100%; }

        /* Sub Pages */
        .sub-page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-color); z-index: 2000;
            display: flex; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        .sub-page.open { transform: translateX(0); }
        .sub-header {
            padding: 15px 20px; background: var(--menu-bg);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; gap: 15px;
        }
        .back-btn { font-size: 1.2rem; color: var(--accent-color); background: none; border: none; padding: 5px; cursor: pointer;}
        .sub-header h2 { margin: 0; font-size: 1.1rem; font-family: "Shippori Mincho", serif; }
        .sub-content { flex: 1; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; }

        /* --- Timeline & Cards --- */
        .timeline-container { padding: 0 20px; }
        .timeline-item {
            position: relative; padding-left: 25px; padding-bottom: 30px;
            border-left: 2px solid rgba(233, 84, 100, 0.3);
            transition: all 0.3s ease; /* åŠ å…¥éæ¸¡å‹•ç•« */
        }
        .timeline-item.hidden { display: none; } /* éš±è—ç¯©é¸å¾Œçš„é …ç›® */
        
        .timeline-item:last-child { border-left: 2px solid transparent; padding-bottom: 0; }
        .timeline-item::before {
            content: ''; position: absolute; left: -6px; top: 18px;
            width: 10px; height: 10px; background: var(--accent-color);
            border-radius: 50%; box-shadow: 0 0 0 4px rgba(62, 60, 58, 1);
        }

        .card {
            background-color: var(--card-color); color: var(--text-on-light);
            border-radius: 12px; padding: 16px; margin-bottom: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2); cursor: pointer;
            position: relative;
        }
        .card:active { transform: scale(0.98); }
        .card-time { font-size: 0.85rem; color: var(--accent-color); font-weight: 700; display: block; margin-bottom: 6px; }
        .card-title { font-size: 1.1rem; font-weight: 700; margin: 0 0 8px 0; font-family: "Shippori Mincho", serif; line-height: 1.4; padding-right: 10px;}
        .card-price {
            position: absolute; bottom: 12px; right: 15px;
            font-weight: bold; color: #d63345; font-size: 0.9rem;
            background: rgba(255,255,255,0.6); padding: 2px 6px; border-radius: 4px;
        }

        .tags { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 5px; max-width: 70%; }
        .card-tag { font-size: 0.7rem; background: #D0D0D0; padding: 3px 8px; border-radius: 4px; color: #444; }
        .card-tag.highlight { background: #ffe4e6; color: #d63345; border: 1px solid #fab1b8; }
        .card-tag.tips { background: #e0f2fe; color: #0369a1; }
        .card-tag.alert { background: #fee2e2; color: #b91c1c; border: 1px solid #f87171; font-weight: bold;}

        /* --- Weather Styles --- */
        .weather-card {
            background: var(--weather-gradient);
            border-radius: 16px; padding: 25px; margin: 20px;
            text-align: center; color: white;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            position: relative; overflow: hidden;
        }
        .weather-card.hot { background: var(--weather-gradient-hot); } 
        
        .weather-source-badge {
            position: absolute; top: 10px; right: 10px;
            font-size: 0.65rem; background: rgba(0,0,0,0.3);
            padding: 3px 8px; border-radius: 10px; opacity: 0.8;
        }
        .weather-main { display: flex; justify-content: space-around; align-items: center; margin: 20px 0; }
        .weather-icon { font-size: 3.5rem; }
        .weather-temp { font-size: 3rem; font-weight: 300; }
        .weather-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; }
        .w-item { font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }

        /* --- Shopping Styles --- */
        .shopping-section-title { font-family: "Shippori Mincho", serif; margin: 0 0 10px 0; color: var(--accent-color); border-bottom: 1px solid #555; padding-bottom: 5px;}
        .shopping-group { margin-bottom: 25px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; }

        /* --- Tools Grid --- */
        .tools-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 10px; }
        .tool-btn {
            background: rgba(255,255,255,0.08); padding: 25px 15px;
            border-radius: 16px; text-align: center;
            border: 1px solid rgba(255,255,255,0.05); cursor: pointer;
        }
        .tool-btn i { font-size: 2.2rem; color: var(--accent-color); margin-bottom: 12px; display: block; }

        /* --- Lists & Footer --- */
        .checklist-item {
            background: rgba(255,255,255,0.08); padding: 15px; margin-bottom: 12px;
            border-radius: 8px; display: flex; align-items: center; gap: 15px;
        }
        .checklist-item.checked { opacity: 0.5; }
        .checklist-item.checked span { text-decoration: line-through; }
        .checklist-item input { width: 22px; height: 22px; accent-color: var(--accent-color); }
        
        nav.bottom-nav {
            position: fixed; bottom: 0; width: 100%;
            background-color: var(--menu-bg);
            display: flex; justify-content: space-around;
            padding: 10px 0 25px 0; border-top: 1px solid rgba(255,255,255,0.1); z-index: 100;
        }
        .nav-item { color: #888; text-align: center; font-size: 0.75rem; cursor: pointer; width: 25%; }
        .nav-item i { display: block; font-size: 1.4rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--accent-color); }

        /* --- Modal --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 3000;
            justify-content: center; align-items: end; backdrop-filter: blur(3px);
        }
        .modal.open { display: flex; }
        .modal-content {
            background: var(--card-color); color: var(--text-on-light);
            width: 100%; max-width: 600px; max-height: 85vh;
            border-radius: 20px 20px 0 0; padding: 25px;
            overflow-y: auto; animation: slideUp 0.3s ease;
            -webkit-overflow-scrolling: touch;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 1.8rem; color: #888; cursor: pointer; }
        
        .info-row { margin: 12px 0; display: flex; align-items: flex-start; gap: 12px; font-size: 0.95rem; line-height: 1.6; }
        .info-row i { color: var(--accent-color); margin-top: 4px; width: 20px; text-align: center; }
        .note-box {
            background: #f8f8f8; border-left: 4px solid var(--accent-color);
            padding: 15px; margin: 20px 0; border-radius: 0 8px 8px 0;
            font-size: 0.95rem; color: #333; line-height: 1.7;
        }
        .link-btn {
            display: inline-block; background: #eee; color: #333; 
            padding: 6px 12px; border-radius: 4px; text-decoration: none; 
            font-size: 0.85rem; margin-top: 5px; border: 1px solid #ccc;
        }
        .action-btn {
            display: flex; justify-content: center; align-items: center; gap: 8px;
            width: 100%; padding: 14px; margin-top: 20px;
            background: var(--accent-color); color: white;
            text-decoration: none; border-radius: 10px;
            font-weight: bold; font-size: 1rem; border: none; cursor: pointer;
        }
        
        .taxi-card {
            background: #fff; color: #000; padding: 20px; 
            border: 4px solid #000; margin: 15px 0; 
            text-align: center; border-radius: 8px;
        }
        .talk-card {
            background: #fff; color: #333;
            border-radius: 12px; padding: 20px; margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            text-align: center;
        }
        .talk-jp { font-size: 1.4rem; font-weight: bold; margin-bottom: 8px; color: var(--text-on-light); }
        .talk-zh { font-size: 0.9rem; color: #666; }

        /* --- æ–°å¢ï¼šåº•éƒ¨æ‡¸æµ®ç¯©é¸åˆ— --- */
        .filter-dock {
            position: fixed;
            bottom: 75px; /* ä½æ–¼åº•éƒ¨å°èˆªåˆ—ä¸Šæ–¹ */
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            background: rgba(43, 42, 41, 0.95); /* æ·±è‰²åŠé€æ˜èƒŒæ™¯ */
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 999; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
            border: 1px solid rgba(255,255,255,0.1);
            opacity: 0; 
            pointer-events: none; /* é è¨­ä¸å¯é»æ“Š */
            transition: all 0.3s ease;
            transform: translateX(-50%) translateY(20px); /* åˆå§‹ä½ç½®å¾®ä¸‹æ²‰ */
        }

        /* åªæœ‰åœ¨è¡Œç¨‹é é¢ä¸”æœ‰å…§å®¹æ™‚é¡¯ç¤º */
        .filter-dock.visible {
            opacity: 1;
            pointer-events: all;
            transform: translateX(-50%) translateY(0);
        }

        .filter-btn {
            background: transparent;
            border: none;
            color: #888;
            font-size: 0.9rem;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: "Noto Sans TC", sans-serif;
            white-space: nowrap;
            flex: 1;
        }

        .filter-btn:active { transform: scale(0.95); }

        /* æ¿€æ´»ç‹€æ…‹ï¼šæœ±ç´…è‰²é«˜äº® */
        .filter-btn.active {
            background: var(--accent-color);
            color: white;
            box-shadow: 0 2px 8px rgba(233, 84, 100, 0.4);
            font-weight: bold;
        }

    </style>
</head>
<body>

    <header>
        <h1>KYOTO 2026</h1>
        <div class="header-icons">
            <a href="googletranslate://" class="header-btn" title="Google Translate">
                <i class="fa-solid fa-language"></i>
            </a>
            <a href="#" class="header-btn fan-btn" onclick="openToolsPage(); return false;">
                <i class="fa-solid fa-fan fa-spin" style="animation-duration: 10s;"></i>
            </a>
        </div>
    </header>

    <div class="date-selector-container">
        <div class="date-selector" id="date-selector"></div>
    </div>

    <main>
        <div id="page-itinerary" class="page active">
            <div class="timeline-container" id="timeline-container" style="padding-top: 20px;"></div>
            <div style="text-align:center; color:#666; font-size:0.8rem; margin:30px 0;">å¹³å®‰å–œæ¨‚ â€¢ æ»¿è¼‰è€Œæ­¸</div>
        </div>

        <div id="page-map" class="page">
            <div id="map-container"></div>
            <div style="position:absolute; bottom:90px; left:10px; background:rgba(255,255,255,0.9); padding:8px 12px; border-radius:8px; color:#333; font-size:0.8rem; box-shadow:0 2px 5px rgba(0,0,0,0.3); pointer-events:none; z-index:999;">
                <i class="fa-solid fa-location-dot" style="color:var(--accent-color)"></i> é¡¯ç¤ºç•¶æ—¥è¡Œç¨‹åœ°é»
            </div>
        </div>

        <div id="page-weather" class="page">
            <div style="padding: 20px;">
                <h2 style="font-family:'Shippori Mincho',serif; text-align:center; margin-bottom:10px;">ç•¶æ—¥å¤©æ°£é å ±</h2>
                <div id="weather-content">
                    <div style="text-align:center; padding:20px;">
                        <i class="fa-solid fa-spinner fa-spin"></i> æ­£åœ¨é€£ç·š Open-Meteo æ°£è±¡è¡›æ˜Ÿ...
                    </div>
                </div>
                
                <div style="background:rgba(255,255,255,0.1); padding:15px; border-radius:12px; margin:20px 0; display:flex; align-items:center; justify-content:space-between; border:1px solid rgba(255,255,255,0.1);">
                    <div>
                        <div style="font-weight:bold; color:var(--accent-color);"><i class="fa-solid fa-glass-water"></i> æ°´åˆ†è£œçµ¦ Check</div>
                        <div style="font-size:0.8rem; opacity:0.7; margin-top:4px;">å–é…’å‰è«‹å…ˆå–æ°´</div>
                    </div>
                    <div style="display:flex; gap:15px; align-items:center;">
                        <button onclick="addWater()" style="background:var(--accent-color); border:none; color:white; width:45px; height:45px; border-radius:50%; font-size:1.2rem; cursor:pointer;"><i class="fa-solid fa-plus"></i></button>
                        <span id="water-count" style="font-size:2rem; font-family:'Shippori Mincho',serif; min-width:30px; text-align:center;">0</span>
                    </div>
                </div>

                <div class="note-box">
                    <div style="font-weight:bold; margin-bottom:5px; color:var(--accent-color);">7æœˆäº¬éƒ½æ°£å€™ TIPSï¼š</div>
                    äº¬éƒ½ç›†åœ°åœ°å½¢å°è‡´å¤å­£æ¥µåº¦æ‚¶ç†±ï¼ˆå®›å¦‚è’¸ç± ï¼‰ã€‚<br>
                    åˆå¾Œå¸¸æœ‰çªç™¼æ€§é›·é™£é›¨ï¼ˆå¤•ç«‹ï¼‰ï¼Œè«‹å‹™å¿…éš¨èº«æ”œå¸¶è¼•ä¾¿é›¨å‚˜ã€‚<br>
                    é˜²æ›¬èˆ‡è£œæ°´æ˜¯æ¯æ—¥æœ€é‡è¦çš„äº‹ã€‚
                </div>
            </div>
        </div>

        <div id="page-shopping" class="page">
            <div style="padding: 20px;">
                <h2 style="font-family:'Shippori Mincho',serif; text-align:center;">ä»Šæ—¥è³¼ç‰©å»ºè­°</h2>
                <p style="text-align:center; opacity:0.7; font-size:0.85rem; margin-bottom:20px;">æ ¹æ“šç•¶æ—¥è¡Œç¨‹åœ°é»æ¨è–¦</p>
                <div id="daily-shopping-list"></div>
                <div style="margin-top:40px; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">
                    <h3 style="color:#aaa; font-size:1rem;">å…¨è¡Œç¨‹è³¼ç‰©æ¸…å–® (General)</h3>
                    <div id="general-shopping-container"></div>
                </div>
            </div>
        </div>

        <div id="page-tools" class="page">
            <h2 style="text-align:center; margin: 30px 0 20px 0; font-family:'Shippori Mincho',serif;">æ—…äººç™¾å¯¶ç®±</h2>
            <div class="tools-grid">
                <div class="tool-btn" onclick="openSubPage('hotel')"><i class="fa-solid fa-bed"></i><span>é…’åº—è³‡è¨Š</span></div>
                <div class="tool-btn" onclick="openSubPage('packing')"><i class="fa-solid fa-suitcase"></i><span>è¡Œææ¸…å–®</span></div>
                <div class="tool-btn" onclick="openSubPage('rate')"><i class="fa-solid fa-yen-sign"></i><span>åŒ¯ç‡æ›ç®—</span></div>
                <div class="tool-btn" onclick="openSubPage('safety')"><i class="fa-solid fa-user-shield"></i><span>å®‰å…¨å ±å¹³å®‰</span></div>
                <div class="tool-btn" onclick="openSubPage('talk')"><i class="fa-solid fa-comment-dots"></i><span>æ‰‹æŒ‡å°è©±</span></div>
                <div class="tool-btn" onclick="openTipsModal()"><i class="fa-regular fa-compass"></i><span>è·¯ç—´æ•‘æ˜Ÿ</span></div>
            </div>
            <div style="text-align:center; margin-top:30px;">
                <button onclick="history.back()" style="background:none; border:1px solid #777; color:#fff; padding:10px 20px; border-radius:20px;">é—œé–‰ç™¾å¯¶ç®±</button>
            </div>
        </div>

        <div id="subpage-hotel" class="sub-page">
            <div class="sub-header"><button class="back-btn" onclick="closeSubPage('hotel')"><i class="fa-solid fa-arrow-left"></i></button><h2>é…’åº—è³‡è¨Š</h2></div>
            <div class="sub-content">
                <h3 style="color:var(--accent-color); font-family:'Shippori Mincho',serif; margin-bottom:10px;">Dormy Inn Premium Kyoto Ekimae</h3>
                <div style="font-size:0.9rem; opacity:0.8; margin-bottom:20px;">å¤©ç„¶æº«æ³‰æœµç±³ premium äº¬éƒ½ç«™å‰</div>
                <div class="note-box">
                    <i class="fa-solid fa-location-dot" style="color:var(--accent-color)"></i> <b>åœ°å€ï¼š</b><br>äº¬éƒ½å¸‚ä¸‹äº¬å€æ±å¡©å°è·¯ç”º558-8<br>
                    <a href="https://www.google.com/maps/search/?api=1&query=$34.9868,135.7599" target="_blank" class="link-btn" style="margin-top:8px;">é–‹å•Ÿåœ°åœ–</a>
                </div>
                <div class="checklist-item" style="opacity:1;"><i class="fa-regular fa-clock" style="color:var(--accent-color)"></i><span><b>In:</b> 15:00 / <b>Out:</b> 11:00</span></div>
                <h4 style="border-bottom:1px solid #555; padding-bottom:5px; margin-top:25px;">ç¨æ—…ç‰¹è‰²</h4>
                <ul style="padding-left:20px; line-height:1.6; font-size:0.95rem;"><li>é ‚æ¨“å¤©ç„¶æº«æ³‰</li><li>å…è²»å¤œé³´ãè•éº¥éºµ (21:30-23:00)</li><li>å…è²»æ´—è¡£æ©Ÿ</li></ul>
            </div>
        </div>

        <div id="subpage-packing" class="sub-page">
            <div class="sub-header"><button class="back-btn" onclick="closeSubPage('packing')"><i class="fa-solid fa-arrow-left"></i></button><h2>è¡Œææ¸…å–®</h2></div>
            <div class="sub-content" id="packing-list-container"></div>
        </div>
        
        <div id="subpage-rate" class="sub-page">
            <div class="sub-header"><button class="back-btn" onclick="closeSubPage('rate')"><i class="fa-solid fa-arrow-left"></i></button><h2>åŒ¯ç‡æ›ç®—</h2></div>
            <div class="sub-content" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:80%;">
                <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; width:100%;">
                    <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
                         <label style="font-size:0.8rem; color:#aaa;">åŒ¯ç‡: <input type="number" id="rate-setting" value="0.052" step="0.001" style="width:60px; background:transparent; color:#fff; border:1px solid #555; text-align:center; border-radius:4px;"></label>
                    </div>
                    <label>æ—¥å¹£ (JPY)</label><input type="number" id="jpy-input" placeholder="Â¥" oninput="calcRate('jpy')" style="width: 100%; padding: 15px; margin: 10px 0; font-size: 1.2rem; background: rgba(0,0,0,0.3); border: 1px solid #555; color: white; border-radius: 8px; text-align: center;">
                    <div style="text-align:center; font-size:1.5rem; margin:10px 0; color:var(--accent-color);">â‡…</div>
                    <label>æ¸¯å¹£ (HKD)</label><input type="number" id="hkd-input" placeholder="$" oninput="calcRate('hkd')" style="width: 100%; padding: 15px; margin: 10px 0; font-size: 1.2rem; background: rgba(0,0,0,0.3); border: 1px solid #555; color: white; border-radius: 8px; text-align: center;">
                </div>
            </div>
        </div>
        
        <div id="subpage-safety" class="sub-page">
            <div class="sub-header"><button class="back-btn" onclick="closeSubPage('safety')"><i class="fa-solid fa-arrow-left"></i></button><h2>å®‰å…¨åŠŸèƒ½</h2></div>
            <div class="sub-content">
                <div style="text-align: center; padding: 30px 20px; background: linear-gradient(135deg, #2E4B71, #1a2e47); border-radius: 16px; margin-bottom: 20px;" onclick="sendSafetyMessage()">
                    <i class="fa-brands fa-whatsapp" style="font-size:3rem; color:white; margin-bottom:15px;"></i>
                    <h3 style="margin:0 0 10px 0;">ä¸€éµå ±å¹³å®‰ (WhatsApp)</h3>
                    <p style="opacity:0.8; margin:0;">æŒ‰æ­¤ç™¼é€ä½ç½®çµ¦å®¶äºº</p>
                </div>
                <h3 style="border-bottom:1px solid #555; padding-bottom:10px; margin-top:30px;">ç·Šæ€¥è³‡è¨Š</h3>
                <div class="checklist-item" onclick="alert('110')"><i class="fa-solid fa-shield-halved" style="color:var(--accent-color);"></i><span>è­¦å¯Ÿå±€: 110</span></div>
                <div class="checklist-item" onclick="alert('119')"><i class="fa-solid fa-truck-medical" style="color:var(--accent-color);"></i><span>æ•‘è­·/æ¶ˆé˜²: 119</span></div>
            </div>
        </div>

        <div id="subpage-talk" class="sub-page">
            <div class="sub-header"><button class="back-btn" onclick="closeSubPage('talk')"><i class="fa-solid fa-arrow-left"></i></button><h2>æ‰‹æŒ‡æŒ‡å°è©±</h2></div>
            <div class="sub-content">
                <div class="talk-card"><div class="talk-jp">ä¸€äººã§ã™ã€‚</div><div class="talk-zh">æˆ‘æ˜¯ä¸€ä½ã€‚</div></div>
                <div class="talk-card"><div class="talk-jp">ãŠã™ã™ã‚ã¯ä½•ã§ã™ã‹ï¼Ÿ</div><div class="talk-zh">æœ‰æ¨è–¦çš„èœè‰²å—ï¼Ÿ</div></div>
                <div class="talk-card"><div class="talk-jp">ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚</div><div class="talk-zh">éº»ç…©çµå¸³ã€‚</div></div>
                <div class="talk-card"><div class="talk-jp">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã¯<br>ä½¿ãˆã¾ã™ã‹ï¼Ÿ</div><div class="talk-zh">å¯ä»¥ç”¨ä¿¡ç”¨å¡å—ï¼Ÿ</div></div>
                <div class="talk-card"><div class="talk-jp">ã“ã“ã¸è¡Œã£ã¦ãã ã•ã„ã€‚</div><div class="talk-zh">(çµ¦å¸æ©Ÿ) è«‹å»é€™è£¡ã€‚</div></div>
                <div class="talk-card"><div class="talk-jp">ã‚ã•ã³æŠœãã§ãŠé¡˜ã„ã—ã¾ã™ã€‚</div><div class="talk-zh">è«‹ä¸è¦åŠ èŠ¥æœ«ã€‚</div></div>
            </div>
        </div>
        
        <div id="filter-dock" class="filter-dock">
            <button class="filter-btn active" onclick="filterTimeline('all', this)">å…¨éƒ¨</button>
            <button class="filter-btn" onclick="filterTimeline('culture', this)">â›©ï¸ æ–‡åŒ–</button>
            <button class="filter-btn" onclick="filterTimeline('food', this)">ğŸ· é£Ÿé£²</button>
            <button class="filter-btn" onclick="filterTimeline('shopping', this)">ğŸ›ï¸ è³¼ç‰©</button>
        </div>

    </main>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchMainPage('itinerary', this)"><i class="fa-solid fa-calendar-days"></i> è¡Œç¨‹</div>
        <div class="nav-item" onclick="switchMainPage('map', this)"><i class="fa-solid fa-map-location-dot"></i> åœ°åœ–</div>
        <div class="nav-item" onclick="switchMainPage('weather', this)"><i class="fa-solid fa-cloud-sun-rain"></i> å¤©æ°£</div>
        <div class="nav-item" onclick="switchMainPage('shopping', this)"><i class="fa-solid fa-basket-shopping"></i> è³¼ç‰©</div>
    </nav>

    <div id="detail-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">Ã—</span>
            <div class="modal-header"><h2 id="modal-title">æ¨™é¡Œ</h2><span id="modal-type" class="sub">é¡å‹</span></div>
            <div class="modal-body">
                <div id="taxi-card" class="taxi-card" style="display:none;">
                    <p style="font-size:0.8rem; color:#666; margin:0 0 5px 0;">é‹è»¢æ‰‹ã•ã‚“ã€ã“ã“ã¸ãŠé¡˜ã„ã—ã¾ã™</p>
                    <h2 id="taxi-address" style="font-size:1.5rem; margin:5px 0; font-weight:bold; line-height:1.2;"></h2>
                    <p id="taxi-name" style="font-size:1rem; margin-top:5px; color:#444;"></p>
                </div>
                <div class="info-row"><i class="fa-regular fa-clock"></i><span id="modal-time">æ™‚é–“</span></div>
                <div class="info-row"><i class="fa-solid fa-location-dot"></i><span id="modal-address">åœ°å€</span></div>
                <div class="info-row" id="modal-price-row"><i class="fa-solid fa-money-bill-wave"></i><span id="modal-price"></span></div>
                <div class="info-row" style="background:rgba(233,84,100,0.1); padding:8px; border-radius:6px; align-items:center;">
                    <i class="fa-solid fa-calculator"></i><span style="white-space:nowrap;">å¯¦éš›èŠ±è²»(Â¥)ï¼š</span>
                    <input type="number" id="modal-actual-cost" placeholder="0" style="background:transparent; border:none; border-bottom:1px solid #555; width:80px; color:#333; font-size:1rem; text-align:center;" onchange="saveExpense()">
                </div>
                <div class="note-box"><div style="font-weight:bold; margin-bottom:8px; color:var(--accent-color);">æ”»ç•¥èˆ‡ TIPSï¼š</div><span id="modal-note">å…§å®¹...</span></div>
                <div id="modal-links" style="margin-bottom: 20px;"></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">
                     <button class="action-btn" id="modal-map-btn" style="margin-top:0;"><i class="fa-solid fa-map-location-dot"></i> Google å°èˆª</button>
                     <button class="action-btn" onclick="toggleTaxiCard()" style="margin-top:0; background:#444;"><i class="fa-solid fa-taxi"></i> çµ¦å¸æ©Ÿçœ‹</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const scheduleData = {
            "day1": { "date": "2026-07-15", "display": "7/15 (ä¸‰)", "events": [ 
                { time: "14:00 - 16:00", title: "æŠµé”äº¬éƒ½ç«™ & Check-in", type: "äº¤é€š/ä½å®¿", price: "Â¥2,600", address: "Dormy Inn Premium Kyoto Ekimae", coords: [34.9868, 135.7599], note: "<b>äº¤é€šï¼š</b>é—œè¥¿æ©Ÿå ´1F 8è™Ÿæ­åˆ©æœ¨æ´¥å·´å£«ã€‚<br>15:00å¾ŒCheck-inï¼Œè¡Œæå¯å¯„æ”¾ã€‚", link: "https://www.klook.com/activity/1541-kix-airport-limousine-bus-transfer-kyoto/", tags: ["ç§»å‹•", "å…¥ä½"], shopping_items: ["ICOCA (è‹¥éœ€å„²å€¼)", "æ¶¼æ„Ÿæ¿•ç´™å·¾", "é¹½åˆ†è£œçµ¦ç³–"] },
                { time: "åˆé¤ (è‹¥æ—©åˆ°)", title: "æœˆä¹‹è—äºº", type: "ç¾é£Ÿ", price: "Â¥2,500", address: "ä¼è¦‹å€ä¸Šæ²¹æ›ç”º185-1", coords: [34.9310, 135.7610], note: "<b>å¿…é»ï¼š</b>è‡ªå®¶è£½è±†è…ã€é…’ç²•çƒ¤é›ã€‚<br>èˆŠé…’é€ æ”¹å»ºï¼Œæ°›åœæ‡·èˆŠã€‚", tags: ["ç¾é£Ÿ"] },
                { time: "16:00 - 18:00", title: "é»ƒæ«» Kappa Country", type: "æ¸…é…’", price: "Â¥2,000", address: "ä¼è¦‹å€å¡©å±‹ç”º228", coords: [34.9305, 135.7615], note: "<b>å¿…å–ï¼š</b>Lucky Cat/Dog ç²¾é‡€å•¤é…’ã€å¤å­£æŸšå­é…’ã€‚", tags: ["æ¸…é…’", "æ²³ç«¥"], shopping_items: ["é»ƒæ«»æ¸…é…’", "æ²³ç«¥å‘¨é‚Š", "å¤å­£é…’å¥—è£"] },
                { time: "18:00 - 19:00", title: "AEON Mall è¶…å¸‚", type: "è³¼ç‰©", price: "Â¥1,500", address: "äº¬éƒ½ç«™å…«æ¢å£ Sakuraé¤¨", coords: [34.9835, 135.7560], note: "è²·æè±†ã€æ°´èŒ„å­æ¼¬ç‰©ã€åˆºèº«æ‹¼ç›¤å›é…’åº—å°é…Œã€‚", tags: ["è¶…å¸‚", "è£œçµ¦"], shopping_items: ["æè±†", "æ°´èŒ„å­æ¼¬ç‰©", "åˆºèº«æ‹¼ç›¤", "æ—¥æœ¬é…’/å•¤é…’"] },
                { time: "æ™šé¤", title: "Okonomiyaki Katsu", type: "ç¾é£Ÿ", price: "Â¥1,500", address: "äº¬éƒ½å¸‚ä¸‹äº¬å€", coords: [35.0028, 135.7596], note: "<b>å¿…é»ï¼š</b>å¤§é˜ªç‡’å°ä»½ (é…Highball)ã€‚", tags: ["Bç´šç¾é£Ÿ", "å¤§é˜ªç‡’"] }
            ]},
            "day2": { "date": "2026-07-16", "display": "7/16 (å››)", "events": [
                { time: "æ—©é¤", title: "Ogawa Coffee", type: "ç¾é£Ÿ", price: "Â¥1,200", address: "äº¬éƒ½ç«™å‰åœ°ä¸‹", coords: [34.9852, 135.7584], note: "<b>å¿…é»ï¼š</b>äº¬éƒ½æ—©é¤å¥—é¤ã€‚", tags: ["å’–å•¡"] },
                { time: "10:00 - 12:00", title: "æœˆæ¡‚å† å¤§å€‰ç´€å¿µé¤¨", type: "æ™¯é»", price: "Â¥600", address: "ä¼è¦‹å€å—æµœç”º247", coords: [34.9298, 135.7618], note: "<b>é‡é»ï¼š</b>è©¦é£²å¤å­£å†°é®ç”Ÿé…’ã€‚å¿…å–ä¸­åº­ä¼æ°´äº•æ°´ã€‚", link: "https://www.gekkeikan.com/museum/", tags: ["æ¸…é…’", "æ­·å²"], shopping_items: ["æœˆæ¡‚å† ç”Ÿé…’", "æ¸…é…’æ¯"] },
                { time: "12:00 - 13:30", title: "Gion Matayoshi (åˆé¤)", type: "ç¾é£Ÿ", price: "Â¥4,000", address: "ç¥‡åœ’", coords: [35.0050, 135.7750], note: "<b>å¿…é»ï¼š</b>åˆé–“æ‡·çŸ³å¥—é¤ã€‚", tags: ["æ‡·çŸ³", "ç±³å…¶æ—"] },
                { time: "13:30 - 15:30", title: "ä¼è¦‹é…’è”µå°è·¯", type: "é«”é©—", price: "Â¥2,500", address: "ä¼è¦‹å€ç´å±‹ç”º", coords: [34.9330, 135.7605], note: "<b>å¿…é»ï¼š</b>åå…«è—è©¦é£² Setã€‚", link: "https://www.tablecheck.com/en/shops/fushimi-sakagura-kouji/reserve", tags: ["æ¸…é…’"] },
                { time: "16:00 - 17:00", title: "MY ONLY FRAGRANCE", type: "é«”é©—", price: "Â¥6,000", address: "ä¸­äº¬å€ä¸‹ä¸¸å±‹ç”º401-2", coords: [35.0085, 135.7680], note: "èª¿è£½å°ˆå±¬é¦™æ°´ï¼Œå°ä¸Šæ—…ç¨‹æ—¥æœŸã€‚", link: "https://www.kkday.com/en-sg/product/248954", tags: ["é¦™æ°›"], shopping_items: ["å°ˆå±¬é¦™æ°´"] },
                { time: "18:00 - 20:00", title: "Mezopotamia Kebab", type: "ç¾é£Ÿ", price: "Â¥1,000", address: "å››æ¢", coords: [35.0040, 135.7600], note: "<b>å¿…é»ï¼š</b>çƒ¤è‚‰æ²å°ä»½ã€‚", tags: ["è¼•é£Ÿ"] },
                { time: "20:00 å¾Œ", title: "ç¥‡åœ’ç¥­ã€Œå®µå±±ã€æ­¥è¡Œ", type: "ç¥­å…¸", price: "Â¥1,000", address: "å››æ¢çƒä¸¸", coords: [35.0039, 135.7595], note: "<b>å¿…åšï¼š</b>å»ã€Œé•·åˆ€é‰¾ã€è²·å€‹ã€Œç²½ã€ã€‚<br><span style='color:red;'><b>æ³¨æ„ï¼š</b>æ™šé–“æ ¸å¿ƒå€å°è·¯ã€‚</span>", tags: ["ç¥­å…¸", "äº¤é€šç®¡åˆ¶"], shopping_items: ["é•·åˆ€é‰¾ ç²½ (è­·èº«ç¬¦)"] }
            ]},
            "day3": { "date": "2026-07-17", "display": "7/17 (äº”)", "events": [
                { time: "09:00 - 12:00", title: "å±±é‰¾å·¡è¡Œ (å‰ç¥­)", type: "ç¥­å…¸", price: "å…è²»", address: "å¾¡æ± é€š/å¸‚å½¹æ‰€å‰", coords: [35.0116, 135.7681], note: "<b>æ”»ç•¥ï¼š</b>ä¸è¦åœ¨è·¯å£æ“ ã€‚<span style='color:red;'><b>æ³¨æ„ï¼š</b>äººæ½®æ¥µå¤šã€‚</span>", tags: ["ç¥­å…¸", "äº¤é€šç®¡åˆ¶"] },
                { time: "åˆé¤", title: "Kikunoi Lunch Set", type: "ç¾é£Ÿ", price: "Â¥5,000", address: "æœ¨å±‹ç”º/ç¥‡åœ’", coords: [35.0035, 135.7705], note: "<b>å¿…é»ï¼š</b>åˆé–“æ‡·çŸ³å¥—é¤ã€‚", tags: ["æ‡·çŸ³", "ç±³å…¶æ—"] },
                { time: "13:30 - 16:30", title: "ä½ä½æœ¨é…’é€ ", type: "æ™¯é»", price: "Â¥2,000", address: "ä¸Šäº¬å€æ—¥æš®é€šæ¤¹æœ¨ç”º", coords: [35.0232, 135.7516], note: "æ´›ä¸­å”¯ä¸€é…’é€  (ä½ä½æœ¨è—ä¹‹ä»‹è€å®¶)ã€‚", link: "https://wabunka-lux.jp/experiences/en_sasaki-shuzo/", tags: ["é…’é€ "], shopping_items: ["ä½ä½æœ¨é…’é€  èšæ¨‚ç¬¬", "é…’ç²•"] },
                { time: "17:00 - 18:00", title: "Lopia è¶…å¸‚", type: "è³¼ç‰©", price: "Â¥2,000", address: "äº¬éƒ½ç«™ Yodobashi B1", coords: [34.9875, 135.7595], note: "è‚‰é¡æ¥µå¼·ã€‚å¿…è²·è‡ªå®¶è£½é¦™è…¸ã€å¤§ä»½é‡å£½å¸ (å®µå¤œ)ã€‚", tags: ["è¶…å¸‚"], shopping_items: ["è‡ªå®¶è£½é¦™è…¸", "å¤§ä»½é‡å£½å¸"] }
            ]},
             "day4": { "date": "2026-07-18", "display": "7/18 (å…­)", "events": [
                { time: "æ—©é¤ (8:00å‰)", title: "Vermillion Espresso", type: "ç¾é£Ÿ", price: "Â¥1,000", address: "ä¼è¦‹ç¨»è·", coords: [34.9671, 135.7727], note: "<b>æ”»ç•¥ï¼š</b>8é»å‰åˆ°ä¼è¦‹ç¨»è·é¿äººæ½®ã€‚", tags: ["ç¥ç¤¾", "å’–å•¡"], shopping_items: ["ç‹ç‹¸é¢å…·ç…é¤…"] },
                { time: "11:30 - 14:00", title: "è—¤å²¡é…’é€  (è’¼ç©º)", type: "å“é…’", price: "Â¥2,000", address: "ä¼è¦‹", coords: [34.9300, 135.7600], note: "<b>å¿…è¨ªï¼š</b>ç»ç’ƒå±‹é…’å§ã€Œé…’è”µBar Enã€ã€‚", tags: ["æ¸…é…’", "æ–‡é’"], shopping_items: ["è’¼ç©º æ¸…é…’æ¯"] },
                { time: "åˆé¤", title: "Wagyu Teppanyaki Kiyomizu", type: "ç¾é£Ÿ", price: "Â¥4,000", address: "æ¸…æ°´å¯ºå‘¨é‚Š", coords: [34.9960, 135.7800], note: "<b>å¿…é»ï¼š</b>åˆé–“å’Œç‰›éµæ¿ç‡’å¥—é¤ã€‚", tags: ["å’Œç‰›", "éµæ¿ç‡’"] },
                { time: "14:00 - 16:00", title: "å¤©é¦™å ‚ é¦™é“", type: "é«”é©—", price: "Â¥3,500", address: "åµå±±/åµ¯å³¨é‡", coords: [35.0155, 135.6700], note: "è£½ä½œåŒ‚è¢‹ (é¦™åŒ…)ã€‚", link: "https://tenkhodou.com/", tags: ["é¦™æ°›"], shopping_items: ["æ—¥å¼é¦™åŒ… (åŒ‚è¢‹)"] },
                { time: "åŠ ç¢¼", title: "é‡å®®ç¥ç¤¾", type: "æ™¯é»", price: "å…è²»", address: "åµå±±ç«¹æ—å…¥å£", coords: [35.0178, 135.6743], note: "æ±‚è‰¯ç·£æ‘¸é»‘è‰²çš„ã€Œé¾œçŸ³ã€ã€‚", tags: ["çµç·£"], shopping_items: ["æˆ€æ„›å¾¡å®ˆ"] },
                { time: "16:30 - 17:30", title: "æ¥­å‹™è¶…å¸‚", type: "è³¼ç‰©", price: "Â¥1,000", address: "å¸‚å€", coords: [35.0000, 135.7500], note: "è²·æŸšå­èƒ¡æ¤’é†¬ã€ä¸ƒå‘³ç²‰ã€‚", tags: ["è¶…å¸‚"], shopping_items: ["æŸšå­èƒ¡æ¤’", "ä¸ƒå‘³ç²‰"] }
            ]},
            "day5": { "date": "2026-07-19", "display": "7/19 (æ—¥)", "events": [
                { time: "æ—©é¤", title: "Sentido", type: "ç¾é£Ÿ", price: "Â¥1,000", address: "çƒä¸¸å¾¡æ± ", coords: [35.0105, 135.7600], note: "<b>å¿…é»ï¼š</b>ç†±å£“ä¸‰æ˜æ²»ã€‚", tags: ["å’–å•¡"] },
                { time: "10:00 - 13:00", title: "éŒ¦å¸‚å ´ & æ™¯é»åˆé¤", type: "æ™¯é»/åˆé¤", price: "Â¥3,000", address: "éŒ¦å¸‚å ´", coords: [35.0050, 135.7649], note: "<b>å¿…è²·ï¼š</b>æ‰“ç”°æ¼¬ç‰©(æŸ´æ¼¬)ã€‚", tags: ["å¸‚å ´"], shopping_items: ["æ‰“ç”°æ¼¬ç‰© (æŸ´æ¼¬)", "æ´¥ä¹‹å–œé…’èˆ– æ¸…é…’"] },
                { time: "ä¸‹åˆ", title: "ä¸‹é´¨ç¥ç¤¾ & æ²³åˆç¥ç¤¾", type: "æ™¯é»", price: "Â¥800", address: "å‡ºç”ºæŸ³", coords: [35.0345, 135.7720], note: "æ²³åˆç¥ç¤¾å¿…è²·ã€Œé¡ç¹ªé¦¬ã€åŒ–å¦ç¥ˆæ±‚è®Šç¾ã€‚", tags: ["ç¥ç¤¾", "ç¾å®¹"], shopping_items: ["é¡ç¹ªé¦¬ (åŒ–å¦)", "ç¾äººæ°´"] },
                { time: "æ™šé¤", title: "Onigiriya Goku", type: "ç¾é£Ÿ", price: "Â¥1,000", address: "æ²³åŸç”º", coords: [35.0000, 135.7680], note: "<b>å¿…é»ï¼š</b>ç±³é£¯çƒå°ä»½ã€‚", tags: ["è¼•é£Ÿ", "é£¯ç³°"] }
            ]},
            "day6": { "date": "2026-07-20", "display": "7/20 (ä¸€)", "events": [
                { time: "ä¸Šåˆ", title: "äº¬éƒ½æ–‡åŒ–åšç‰©é¤¨", type: "æ™¯é»", price: "Â¥500", address: "ä¸‰æ¢é«˜å€‰", coords: [35.0090, 135.7630], note: "èˆŠéŠ€è¡Œå»ºç¯‰ï¼Œå¾ˆç¾ã€‚é€›äº¬éƒ½å·¥è—å“åº—ã€‚", tags: ["è—æ–‡"], shopping_items: ["äº¬éƒ½å·¥è—å“"] },
                { time: "åˆé¤", title: "Kamigamo Kirin", type: "ç¾é£Ÿ", price: "Â¥1,500", address: "ä¸Šè³€èŒ‚", coords: [35.0550, 135.7550], note: "<b>å¿…é»ï¼š</b>Obanzai è‡ªåŠ©é¤ã€‚", tags: ["Obanzai", "è”¬èœ"] },
                { time: "14:00 - 16:00", title: "ä¼Šå‹¢ä¸¹ Isetan", type: "è³¼ç‰©", price: "Â¥10,000", address: "äº¬éƒ½ç«™", coords: [34.9858, 135.7588], note: "<b>é¦™æ°´ï¼š</b>Shiro / Aux Paradisã€‚<b>è¶…å¸‚ï¼š</b>551è‚‰åŒ…ã€ä¸‹é´¨èŒ¶å¯®ä¾¿ç•¶ã€‚", tags: ["ç™¾è²¨"], shopping_items: ["Shiro / Aux Paradis é¦™æ°´", "551 è‚‰åŒ…", "ä¸‹é´¨èŒ¶å¯® ä¾¿ç•¶"] },
                { time: "20:00 å¾Œ", title: "å¾Œç¥­å±±é‰¾æ­å»º", type: "ç¥­å…¸", price: "å…è²»", address: "çƒä¸¸å¾¡æ± ", coords: [35.0110, 135.7600], note: "çœ‹è·äººã€Œç„¡é‡˜ã€çµ„è£å¤§èˆ¹é‰¾ã€‚", tags: ["å¾Œç¥­"] }
            ]},
            "day7": { "date": "2026-07-21", "display": "7/21 (äºŒ)", "events": [
                { time: "08:00 - 11:00", title: "æ±å¯º å¼˜æ³•å¸‚ (å¤è‘£å¸‚é›†)", type: "å¸‚é›†", price: "Â¥5,000", address: "æ±å¯º", coords: [34.9806, 135.7476], note: "<b>æ¯æœˆ21æ—¥é™å®šï¼</b>æ—©8-9é»å»ã€‚<br>ç›®æ¨™ï¼šè²·ä¸€å€‹å¤è‘£æ¸…é…’æ¯ (çŒªå£)ã€‚", tags: ["å¸‚é›†", "å°‹å¯¶"], shopping_items: ["å¤è‘£çŒªå£æ¯"] },
                { time: "åˆé¤", title: "å¸‚é›†æ”¤è²© / Harvest", type: "ç¾é£Ÿ", price: "Â¥1,500", address: "æ±å¯ºå‘¨é‚Š", coords: [34.9806, 135.7476], note: "åƒæ”¤è²©ç‚’éºµæˆ–å»£å³¶ç‡’ã€‚", tags: ["Bç´šç¾é£Ÿ"] },
                { time: "ä¸‹åˆ", title: "Fresco / Life è¶…å¸‚", type: "è³¼ç‰©", price: "Â¥1,000", address: "äºŒæ¢åŸé™„è¿‘", coords: [35.0140, 135.7450], note: "é †è·¯è£œå……é›¶é£Ÿã€‚", tags: ["è¶…å¸‚"], shopping_items: ["é›¶é£Ÿ", "æ³¡éºµ"] },
                { time: "18:00 - 23:00", title: "å¾Œç¥­å®µå±± (é€šäººç‰ˆ)", type: "ç¥­å…¸", price: "Â¥2,000", address: "çƒä¸¸å¾¡æ± ", coords: [35.0080, 135.7570], note: "çœ‹å±é¢¨ç¥­ã€‚è²·æ¯è·¯é‚Šå†°é®æ¸…é…’ï¼Œåè‘—è½ç¥‡åœ’å›ƒå­ã€‚", tags: ["å®µå±±", "æ°›åœ"] }
            ]},
            "day8": { "date": "2026-07-22", "display": "7/22 (ä¸‰)", "events": [
                { time: "æ—©é¤", title: "Inoda Coffee æœ¬åº—", type: "ç¾é£Ÿ", price: "Â¥1,600", address: "ä¸‰æ¢", coords: [35.0090, 135.7650], note: "<b>å¿…é»ï¼š</b>äº¬ä¹‹æœé£Ÿã€‚", tags: ["è€èˆ–"], shopping_items: ["Inoda å’–å•¡è±†"] },
                { time: "12:00 - 13:00", title: "æœ€å¾Œæ¡è²·", type: "è³¼ç‰©", price: "Â¥3,000", address: "äº¬éƒ½ç«™æ–°å¹¹ç·šå£", coords: [34.9858, 135.7588], note: "<b>å¿…è²·ï¼š</b>é˜¿é—æ¢¨é¤… (è»Ÿç³¯ç´…è±†é¤…)ã€‚", tags: ["ä¼´æ‰‹ç¦®"], shopping_items: ["é˜¿é—æ¢¨é¤…"] },
                { time: "åˆé¤", title: "Premium Pound Gion", type: "ç¾é£Ÿ", price: "Â¥3,000", address: "ç¥‡åœ’", coords: [35.0050, 135.7750], note: "<b>å¿…é»ï¼š</b>åˆé–“å’Œç‰›å¥—é¤ã€‚<br>é›¢é–‹å‰çš„æœ€å¾Œäº«å—ã€‚", tags: ["å’Œç‰›"] },
                { time: "å‰å¾€æ©Ÿå ´", title: "åˆ©æœ¨æ´¥å·´å£«", type: "äº¤é€š", price: "Â¥2,600", address: "äº¬éƒ½ç«™å…«æ¢å£", coords: [34.9839, 135.7593], note: "å¸¶è‘—æˆ°åˆ©å“å›å®¶ï¼", link: "https://www.klook.com/activity/1541-kix-airport-limousine-bus-transfer-kyoto/", tags: ["ç§»å‹•"] }
            ]}
        };

        const packingList = ["è­·ç…§", "ICOCA", "è¡Œå‹•é›»æº", "é›¨å…·", "é˜²æ›¬", "å¥½èµ°çš„é‹", "è—¥å“", "ç¶²å¡"];
        const generalShoppingListItems = ["é˜¿é—æ¢¨é¤…", "551 è‚‰åŒ…", "ä¸‹é´¨èŒ¶å¯® ä¾¿ç•¶", "å¤è‘£çŒªå£æ¯", "MY ONLY FRAGRANCE é¦™æ°´", "Shiro / Aux Paradis", "æ‰“ç”°æ¼¬ç‰©", "æ´¥ä¹‹å–œé…’èˆ– æ¸…é…’", "æŸšå­èƒ¡æ¤’", "é•·åˆ€é‰¾ ç²½", "æ¶¼æ„Ÿæ¿•ç´™å·¾", "é¹½åˆ†è£œçµ¦ç³–"];

        let currentDay = "day1";
        let map = null;
        let markers = [];
        let waterCount = 0;
        let currentModalEventTitle = "";
        let weatherData = null; // Store fetched weather data
        const STORAGE_KEY = 'kyoto_2026_final_v2';

        // Open-Meteo WMO Code Mapping
        const wmoMap = {
            0: {icon: 'fa-sun', text: 'æ™´æœ—'}, 1: {icon: 'fa-cloud-sun', text: 'å¤šé›²'}, 2: {icon: 'fa-cloud', text: 'é™°å¤©'}, 
            3: {icon: 'fa-cloud', text: 'é™°å¤©'}, 45: {icon: 'fa-smog', text: 'éœ§'}, 48: {icon: 'fa-smog', text: 'éœ§'},
            51: {icon: 'fa-cloud-rain', text: 'æ¯›æ¯›é›¨'}, 53: {icon: 'fa-cloud-rain', text: 'å°é›¨'}, 55: {icon: 'fa-cloud-showers-heavy', text: 'ä¸­é›¨'},
            61: {icon: 'fa-cloud-showers-heavy', text: 'é™£é›¨'}, 63: {icon: 'fa-cloud-showers-heavy', text: 'ä¸‹é›¨'}, 65: {icon: 'fa-cloud-showers-water', text: 'å¤§é›¨'},
            80: {icon: 'fa-cloud-rain', text: 'é™£é›¨'}, 81: {icon: 'fa-cloud-showers-heavy', text: 'å¤§é›¨'}, 82: {icon: 'fa-cloud-showers-water', text: 'æš´é›¨'},
            95: {icon: 'fa-cloud-bolt', text: 'é›·é›¨'}, 96: {icon: 'fa-cloud-bolt', text: 'é›·é™£é›¨'}, 99: {icon: 'fa-cloud-bolt', text: 'è±ªå¤§é›·é›¨'}
        };

        function init() { 
            renderDateSelector(); 
            renderPackingList();
            renderGeneralShoppingList();
            initMap();
            loadState();
            fetchWeather(); // New: Fetch real weather
            checkDateAndInit();
        }

        async function fetchWeather() {
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=35.0116&longitude=135.7681&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max&current_weather=true&timezone=Asia%2FTokyo');
                weatherData = await res.json();
                renderWeather(currentDay); 
            } catch(e) {
                console.error("Weather fetch failed", e);
            }
        }

        function checkDateAndInit() {
            const today = new Date();
            const month = today.getMonth() + 1;
            const day = today.getDate();
            const year = today.getFullYear();
            const todayStr = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            let targetDay = "day1";
            let found = false;

            Object.keys(scheduleData).forEach(key => {
                if (scheduleData[key].date === todayStr) {
                    targetDay = key;
                    found = true;
                }
            });

            const chips = document.querySelectorAll('.date-chip');
            if(found) {
                chips.forEach(chip => {
                    if(chip.innerText.includes(`D${targetDay.replace('day','')}`)) {
                        selectDay(targetDay, chip);
                        chip.scrollIntoView({behavior: "smooth", inline: "center", block: "nearest"});
                    }
                });
            } else {
                selectDay('day1', chips[0]);
            }
        }

        function saveState() {
            const state = { checks: {}, water: waterCount, expenses: {} };
            document.querySelectorAll('input[type="checkbox"]').forEach(input => {
                if(input.id) state.checks[input.id] = input.checked;
            });
            const savedRaw = localStorage.getItem(STORAGE_KEY);
            let savedExpenses = {};
            if(savedRaw) { try { savedExpenses = JSON.parse(savedRaw).expenses || {}; } catch(e){} }
            state.expenses = savedExpenses;
            const costInput = document.getElementById('modal-actual-cost');
            if(costInput && currentModalEventTitle) { state.expenses[currentModalEventTitle] = costInput.value; }
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return;
            try {
                const state = JSON.parse(saved);
                if (typeof state.water === 'number') {
                    waterCount = state.water;
                    const wc = document.getElementById('water-count');
                    if(wc) wc.innerText = waterCount;
                }
                setTimeout(() => {
                    Object.keys(state.checks).forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.checked = state.checks[id];
                            if(el.parentElement.classList.contains('checklist-item')) el.parentElement.classList.toggle('checked', el.checked);
                        }
                    });
                }, 100);
            } catch (e) { console.error("Load failed", e); }
        }
        
        function saveExpense() { saveState(); }
        function getSavedExpense(title) {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return "";
            try { const state = JSON.parse(saved); return state.expenses && state.expenses[title] ? state.expenses[title] : ""; } catch(e) { return ""; }
        }

        // --- Modified: switchMainPage to control Filter Dock ---
        function switchMainPage(pageId, navEl) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            // [æ–°å¢] æ§åˆ¶ç¯©é¸åˆ—çš„é¡¯ç¤º/éš±è—
            const filterDock = document.getElementById('filter-dock');
            if (filterDock) {
                if (pageId === 'itinerary') {
                    filterDock.classList.add('visible');
                } else {
                    filterDock.classList.remove('visible');
                }
            }

            if(navEl) navEl.classList.add('active');
            else {
                const idx = ['itinerary', 'map', 'weather', 'shopping'].indexOf(pageId);
                if(idx !== -1) document.querySelectorAll('.nav-item')[idx].classList.add('active');
            }
            if(pageId === 'map' && map) setTimeout(() => { map.invalidateSize(); fitMapToDay(); }, 200);
        }

        function openToolsPage() {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-tools').classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        }

        function openSubPage(id) { document.getElementById('subpage-' + id).classList.add('open'); }
        function closeSubPage(id) { document.getElementById('subpage-' + id).classList.remove('open'); }

        function renderDateSelector() {
            const container = document.getElementById('date-selector'); container.innerHTML = '';
            Object.keys(scheduleData).forEach(dayKey => {
                const dayInfo = scheduleData[dayKey];
                const dayNum = dayKey.replace('day', '');
                const chip = document.createElement('div');
                chip.className = `date-chip`;
                chip.onclick = () => selectDay(dayKey, chip);
                chip.innerHTML = `<span class="day-num">D${dayNum}</span><span class="day-week">${dayInfo.display.split(' ')[0]}</span>`;
                container.appendChild(chip);
            });
        }

        function selectDay(dayKey, chipEl) {
            currentDay = dayKey;
            document.querySelectorAll('.date-chip').forEach(c => c.classList.remove('active'));
            if(chipEl) chipEl.classList.add('active');
            renderTimeline(dayKey);
            renderWeather(dayKey); 
            renderDailyShopping(dayKey);
            if(map) updateMapMarkers(dayKey);
            loadState(); 
        }

        // --- Modified: renderTimeline with Auto-Categorization ---
        function renderTimeline(dayKey) {
            const container = document.getElementById('timeline-container'); 
            container.innerHTML = '';
            
            // é‡ç½®ç¯©é¸åˆ—
            const filterDock = document.getElementById('filter-dock');
            if(filterDock) {
                filterDock.classList.add('visible');
                resetFilterBtns();
            }

            const dayTitle = document.createElement('h3'); 
            dayTitle.style.marginBottom='20px';
            dayTitle.innerHTML = `<span style="color:var(--accent-color); font-family:'Shippori Mincho',serif;">${scheduleData[dayKey].display}</span>`;
            container.appendChild(dayTitle);
            
            scheduleData[dayKey].events.forEach(event => {
                const item = document.createElement('div'); 
                item.className = 'timeline-item';
                
                // [æ–°å¢é‚è¼¯] è‡ªå‹•åˆ¤æ–·é¡åˆ¥
                const category = getCategoryByType(event.type);
                item.setAttribute('data-category', category);

                let tagsHtml = event.tags.map(t => {
                    let c = 'card-tag'; 
                    if(t.includes('å¿…')||t.includes('è·¯ç—´')||t.includes('é‡é»')) c+=' highlight';
                    if(t.includes('ç®¡åˆ¶')) c+=' alert';
                    return `<span class="${c}">${t}</span>`;
                }).join('');
                
                let priceHtml = event.price ? `<div class="card-price">${event.price}</div>` : '';
                
                item.innerHTML = `<div class="card" onclick='openEventModal(${JSON.stringify(event).replace(/'/g, "'")})'>
                    <span class="card-time">${event.time}</span><h3 class="card-title">${event.title}</h3><div class="tags">${tagsHtml}</div>${priceHtml}</div>`;
                container.appendChild(item);
            });
            
            // åº•éƒ¨å¢Šé«˜
            const padding = document.createElement('div');
            padding.style.height = "60px";
            container.appendChild(padding);
        }

        // --- New: Logic Helpers ---
        function getCategoryByType(type) {
            if (type.match(/ç¾é£Ÿ|å“é…’|æ¸…é…’|å’–å•¡|æ‡·çŸ³|ç±³å…¶æ—|è¼•é£Ÿ|Bç´š|Obanzai|è€èˆ–|å’Œç‰›/)) return 'food';
            if (type.match(/è³¼ç‰©|å¸‚é›†|ç™¾è²¨|ä¼´æ‰‹ç¦®|è¶…å¸‚/)) return 'shopping';
            if (type.match(/æ™¯é»|ç¥­å…¸|ç¥ç¤¾|é«”é©—|æ­·å²|äº¤é€š|è—æ–‡|å®µå±±|å¾Œç¥­|ä½å®¿/)) return 'culture';
            return 'other'; 
        }

        function filterTimeline(category, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const items = document.querySelectorAll('.timeline-item');
            items.forEach(item => {
                const itemCat = item.getAttribute('data-category');
                if (category === 'all' || itemCat === category) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }

        function resetFilterBtns() {
            const btns = document.querySelectorAll('.filter-btn');
            btns.forEach(b => b.classList.remove('active'));
            btns[0].classList.add('active');
        }

        function renderWeather(dayKey) {
            const container = document.getElementById('weather-content');
            const targetDate = scheduleData[dayKey].date; 
            
            let realData = null;
            let isReal = false;

            if (weatherData && weatherData.daily && weatherData.daily.time) {
                const index = weatherData.daily.time.indexOf(targetDate);
                if (index !== -1) {
                    realData = {
                        max: weatherData.daily.temperature_2m_max[index],
                        min: weatherData.daily.temperature_2m_min[index],
                        code: weatherData.daily.weathercode[index],
                        rain: weatherData.daily.precipitation_probability_max[index]
                    };
                    isReal = true;
                }
            }

            if (!isReal) {
                const baseTemp = 34;
                const dayIndex = parseInt(dayKey.replace('day', ''));
                realData = {
                    max: baseTemp + (dayIndex % 2 === 0 ? 1 : -1),
                    min: 26,
                    code: (dayIndex % 3 === 0) ? 95 : ((dayIndex % 4 === 0) ? 0 : 1), 
                    rain: (dayIndex % 3 === 0) ? 60 : 20
                };
            }

            const wmo = wmoMap[realData.code] || {icon: 'fa-cloud', text: 'å¤šé›²'};
            const sourceText = isReal ? "å³æ™‚è¡›æ˜Ÿé å ± (Open-Meteo)" : "æ­·å²å¹³å‡æ°£å€™ (æ¨¡æ“¬)";
            const bgClass = realData.max > 32 ? "hot" : "";

            container.innerHTML = `
                <div class="weather-card ${bgClass}">
                    <div class="weather-source-badge">${sourceText}</div>
                    <div style="font-size:0.9rem; opacity:0.9;">${scheduleData[dayKey].display} â€¢ äº¬éƒ½</div>
                    <div class="weather-main">
                        <div class="weather-icon"><i class="fa-solid ${wmo.icon}"></i></div>
                        <div class="weather-temp">${Math.round(realData.max)}Â°C</div>
                    </div>
                    <div style="font-size:1.2rem; margin-bottom:15px;">${wmo.text} <span style="font-size:0.8rem; opacity:0.8;">(ä½æº« ${Math.round(realData.min)}Â°)</span></div>
                    <div class="weather-grid">
                        <div class="w-item"><i class="fa-solid fa-umbrella"></i> é™é›¨ ${realData.rain}%</div>
                        <div class="w-item"><i class="fa-solid fa-wind"></i> é¢¨é€Ÿ 2ç´š</div>
                        <div class="w-item"><i class="fa-solid fa-droplet"></i> æ¿•åº¦ 75%</div>
                        <div class="w-item"><i class="fa-solid fa-temperature-arrow-up"></i> é«”æ„Ÿ ${Math.round(realData.max)+4}Â°</div>
                    </div>
                </div>
            `;
        }
        
        function addWater() {
            waterCount++;
            document.getElementById('water-count').innerText = waterCount;
            saveState();
        }

        function renderDailyShopping(dayKey) {
            const container = document.getElementById('daily-shopping-list');
            container.innerHTML = '';
            const events = scheduleData[dayKey].events;
            let hasItems = false;
            events.forEach(event => {
                if (event.shopping_items && event.shopping_items.length > 0) {
                    hasItems = true;
                    const group = document.createElement('div');
                    group.className = 'shopping-group';
                    let itemsHtml = '';
                    event.shopping_items.forEach((item, i) => {
                        const id = `shop-${dayKey}-${event.title}-${i}`.replace(/\s+/g, '');
                        itemsHtml += `<div class="checklist-item" onclick="toggleCheck(this)"><input type="checkbox" id="${id}"><label for="${id}"><span>${item}</span></label></div>`;
                    });
                    group.innerHTML = `<h4 class="shopping-section-title"><i class="fa-solid fa-location-dot"></i> ${event.title}</h4>${itemsHtml}`;
                    container.appendChild(group);
                }
            });
            if (!hasItems) container.innerHTML = `<div style="text-align:center; padding:30px; opacity:0.5;"><i class="fa-solid fa-bag-shopping" style="font-size:2rem; margin-bottom:10px;"></i><br>æœ¬æ—¥ä»¥è§€å…‰ç‚ºä¸»ï¼Œç„¡ç‰¹å®šè³¼ç‰©å»ºè­°</div>`;
        }

        function renderGeneralShoppingList() {
            const container = document.getElementById('general-shopping-container');
            generalShoppingListItems.forEach((item,i) => container.innerHTML += `<div class="checklist-item" onclick="toggleCheck(this)"><input type="checkbox" id="g${i}"><label for="g${i}"><span>${item}</span></label></div>`);
        }

        function renderPackingList() {
            const pC = document.getElementById('packing-list-container');
            pC.innerHTML = '';
            packingList.forEach((item,i) => pC.innerHTML += `<div class="checklist-item" onclick="toggleCheck(this)"><input type="checkbox" id="p${i}"><label for="p${i}"><span>${item}</span></label></div>`);
        }
        
        function toggleCheck(el) { 
            const i = el.querySelector('input'); 
            if(event.target !== i) i.checked = !i.checked; 
            el.classList.toggle('checked', i.checked); 
            saveState();
        }

        function calcRate(type) {
            const rate = parseFloat(document.getElementById('rate-setting').value) || 0.052;
            const jpy = document.getElementById('jpy-input'); 
            const hkd = document.getElementById('hkd-input');
            if(type==='jpy') {
                if(jpy.value === '') hkd.value = ''; else hkd.value = (jpy.value * rate).toFixed(1); 
            } else {
                if(hkd.value === '') jpy.value = ''; else jpy.value = (hkd.value / rate).toFixed(0);
            }
        }

        function sendSafetyMessage() {
             if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(pos) {
                    const link = `https://www.google.com/maps/search/?api=1&query=${pos.coords.latitude},${pos.coords.longitude}`;
                    window.open(`https://wa.me/?text=${encodeURIComponent("Hello! æˆ‘åœ¨äº¬éƒ½ä¸€åˆ‡å®‰å¥½ï¼Œç›®å‰ä½ç½®ï¼š" + link)}`, '_blank');
                });
            } else alert("ç„¡æ³•ç²å–å®šä½");
        }

        function openEventModal(event) {
            currentModalEventTitle = event.title;
            document.getElementById('modal-title').innerText = event.title;
            document.getElementById('modal-type').innerText = event.type;
            document.getElementById('modal-time').innerText = event.time;
            document.getElementById('modal-address').innerText = event.address;
            document.getElementById('modal-note').innerHTML = event.note;
            document.getElementById('modal-actual-cost').value = getSavedExpense(event.title);
            document.getElementById('taxi-address').innerText = event.address;
            document.getElementById('taxi-name').innerText = event.title;
            document.getElementById('taxi-card').style.display = 'none';
            const priceRow = document.getElementById('modal-price-row');
            if (event.price) { priceRow.style.display = 'flex'; document.getElementById('modal-price').innerText = "é ç®—/é–€ç¥¨ï¼š" + event.price; } else { priceRow.style.display = 'none'; }
            const lc = document.getElementById('modal-links'); lc.innerHTML = '';
            if(event.link) lc.innerHTML = `<a href="${event.link}" target="_blank" class="link-btn"><i class="fa-solid fa-link"></i> é ç´„/è©³æƒ…</a>`;
            let mapUrl = "";
            if(event.coords) mapUrl = `https://www.google.com/maps/search/?api=1&query=${event.coords[0]},${event.coords[1]}`;
            else { const q = encodeURIComponent(event.address + " " + event.title); mapUrl = `https://www.google.com/maps/search/?api=1&query=${q}`; }
            document.getElementById('modal-map-btn').onclick = () => window.open(mapUrl, '_blank');
            document.getElementById('detail-modal').classList.add('open');
        }
        
        function toggleTaxiCard() {
            const card = document.getElementById('taxi-card');
            card.style.display = card.style.display === 'none' ? 'block' : 'none';
        }

        function closeModal() { document.getElementById('detail-modal').classList.remove('open'); currentModalEventTitle = ""; }
        document.getElementById('detail-modal').addEventListener('click', function(e){if(e.target===this)closeModal()});
        function openTipsModal() { openEventModal({title:"è·¯ç—´æ•‘æ˜Ÿ",type:"TIPS",time:"éš¨æ™‚",address:"äº¬éƒ½å…¨å€",note:"1.äº¬éƒ½å¡”åœ¨åŒ—é‚Š (è»Šç«™æ­£é¢)<br>2.å…¬è»Šå¾Œé–€ä¸Šè»Šï¼Œå‰é–€ä»˜æ¬¾<br>3.å–„ç”¨Google Live View ARå°èˆª<br>4.è¿·è·¯å°±æ­è¨ˆç¨‹è»Š (é–€è‡ªå‹•é–‹)", tags:[]}); }

        function initMap() {
            map = L.map('map-container');
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);
            updateMapMarkers(currentDay);
        }

        function updateMapMarkers(dayKey) {
            if(!map) return;
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            const events = scheduleData[dayKey].events;
            const group = new L.featureGroup();
            events.forEach(event => {
                if(event.coords) {
                    const navUrl = `https://www.google.com/maps/search/?api=1&query=${event.coords[0]},${event.coords[1]}`;
                    const popupContent = `<div style="text-align:center"><b>${event.title}</b><br>${event.time}<br><a href="${navUrl}" target="_blank" style="display:inline-block; margin-top:5px; color:#E95464; text-decoration:none; font-weight:bold;"><i class="fa-solid fa-location-arrow"></i> å°èˆª</a></div>`;
                    const m = L.marker(event.coords).addTo(map).bindPopup(popupContent);
                    markers.push(m);
                    group.addLayer(m);
                }
            });
            if(markers.length > 0) map.fitBounds(group.getBounds(), {padding: [50, 50]}); else map.setView([35.0000, 135.7600], 13);
        }
        
        function fitMapToDay() { if(map && markers.length > 0) { const group = new L.featureGroup(markers); map.fitBounds(group.getBounds(), {padding: [50, 50]}); } }

        init();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Kyoto 2026 Assistant (v15.0)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
:root {
    --bg-body: #F8F9FA; 
    --bg-card: #FFFFFF; 
    --text-main: #1C1C1E; 
    --text-sub: #8E8E93; 
    --accent: #007AFF; /* iOS Blue style or keep Black #000 */
    --accent-black: #000000;
    --border: #E5E5EA; 
    --shadow: 0 4px 12px rgba(0,0,0,0.03);
    --sidebar-width: 300px;
    --safe-area-bottom: env(safe-area-inset-bottom);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

body {
    font-family: "Inter", "Noto Sans TC", sans-serif;
    background-color: var(--bg-body);
    color: var(--text-main);
    margin: 0; padding: 0;
    height: 100vh;
    display: flex; flex-direction: column; overflow: hidden;
}

/* --- Header --- */
header {
    padding: 0 20px;
    background-color: rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center;
    height: 60px; flex-shrink: 0; position: relative; z-index: 200;
}
header h1 { margin: 0; font-size: 1.1rem; font-weight: 800; letter-spacing: -0.5px; }
.header-actions { display: flex; align-items: center; gap: 8px; }
.header-btn { 
    font-size: 1.1rem; cursor: pointer; color: var(--text-main); 
    border-radius: 50%; transition: background 0.2s; width: 40px; height: 40px;
    display: flex; justify-content: center; align-items: center; background: #F2F2F7;
}
.header-btn:active { background: #E5E5EA; transform: scale(0.95); }

/* --- Toast Notification --- */
#toast {
    position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
    background: rgba(0,0,0,0.8); color: white; padding: 10px 20px;
    border-radius: 30px; font-size: 0.9rem; z-index: 9999;
    opacity: 0; pointer-events: none; transition: opacity 0.3s;
    display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
#toast.show { opacity: 1; }

/* --- Sidebar --- */
.sidebar-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.4); z-index: 1000;
    opacity: 0; pointer-events: none; transition: opacity 0.3s;
    backdrop-filter: blur(4px);
}
.sidebar-overlay.open { opacity: 1; pointer-events: all; }

.sidebar {
    position: fixed; top: 0; right: 0; width: 85%; max-width: var(--sidebar-width); height: 100%;
    background: #FFF; z-index: 1001;
    transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    overflow-y: auto; padding: 25px 20px 100px 20px;
    box-shadow: -5px 0 20px rgba(0,0,0,0.1); display: flex; flex-direction: column;
}
.sidebar.open { transform: translateX(0); }

.sidebar-section-title {
    font-size: 0.75rem; color: #8E8E93; text-transform: uppercase; letter-spacing: 1px; 
    margin-bottom: 10px; margin-top: 30px; font-weight: 600;
}

/* Tools */
.whatsapp-box { 
    background: #E8F5E9; border: 1px solid #C8E6C9; color: #1B5E20; 
    padding: 15px; border-radius: 16px; margin-top: 20px;
}
.wa-input {
    width: 100%; padding: 12px; margin: 10px 0; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px;
    font-size: 1rem; background: rgba(255,255,255,0.8);
}
.wa-btn {
    width: 100%; background: #25D366; color: white; border: none; padding: 12px;
    border-radius: 8px; font-weight: bold; cursor: pointer; 
    display: flex; justify-content: center; align-items: center; gap: 8px; font-size: 0.95rem;
    box-shadow: 0 2px 5px rgba(37, 211, 102, 0.2);
}

.tool-box { background: #FFFFFF; padding: 15px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 10px; box-shadow: var(--shadow); }
.currency-grid { display: grid; grid-template-columns: 1fr 30px 1fr; align-items: center; gap: 5px; margin-bottom: 8px; }
.curr-group { display: flex; flex-direction: column; }
.curr-label { font-size: 0.7rem; color: var(--text-sub); font-weight: bold; margin-bottom: 4px; padding-left: 2px;}
.curr-input { width: 100%; padding: 12px; border: 1px solid #F2F2F7; border-radius: 10px; font-size: 1.2rem; text-align: center; background: #F9F9F9; font-weight: 600; color: #333; }
.curr-input:focus { background: #FFF; border-color: #000; }

.curr-icon { text-align: center; color: #CCC; font-size: 0.9rem; margin-top: 15px;} 

.rate-info-container { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; font-size: 0.75rem; color: var(--text-sub);}
.rate-status { display: flex; align-items: center; gap: 5px; font-weight: 500;}
.rate-actions { display: flex; gap: 10px; }
.rate-btn-text { cursor: pointer; color: #007AFF; font-weight: 500; }

.memo-area { width: 100%; height: 120px; padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-family: inherit; font-size: 0.95rem; resize: none; background: #F9F9F9; line-height: 1.5; }
.memo-area:focus { background: #FFF; border-color: #999; }

/* --- Date Selector --- */
.date-selector-container { 
    background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
    padding: 5px 0; border-bottom: 1px solid var(--border); 
    width: 100%; flex-shrink: 0; position: relative; z-index: 90; 
}
.date-selector { display: flex; gap: 12px; overflow-x: auto; scrollbar-width: none; padding: 10px 15px; }
.date-chip { 
    flex: 0 0 auto; min-width: 65px; padding: 8px 0; border-radius: 12px; 
    cursor: pointer; color: var(--text-sub); display: flex; flex-direction: column; 
    align-items: center; justify-content: center; background: #F2F2F7; 
    transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}
.date-chip.active { 
    background: var(--accent-black); color: #FFF; 
    transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.15); 
}
.day-num { font-weight: 700; font-size: 1rem; line-height: 1.2; } 
.day-week { font-size: 0.7rem; margin-top: 2px; font-weight: 500; }

/* --- Main Pages --- */
main { flex: 1; overflow-y: hidden; position: relative; }
.page { 
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
    overflow-y: auto; padding: 20px 0 100px 0; 
    display: none; opacity: 0; transition: opacity 0.2s ease; 
    background-color: var(--bg-body); 
    -webkit-overflow-scrolling: touch;
}
.page.active { display: block; opacity: 1; z-index: 10; }
.page-header { padding: 0 20px; margin-bottom: 20px; }
.page-title { font-size: 1.7rem; font-weight: 800; margin: 0; letter-spacing: -0.5px; }

/* --- Timeline --- */
.timeline-container { padding: 10px 20px; max-width: 800px; margin: 0 auto; }
.timeline-item { position: relative; padding-left: 28px; padding-bottom: 30px; border-left: 2px solid #E5E5EA; }
.timeline-item:last-child { border-left: 2px solid transparent; }
.timeline-item::before { 
    content: ''; position: absolute; left: -6px; top: 22px; width: 10px; height: 10px; 
    background: #FFF; border: 2px solid #C7C7CC; border-radius: 50%; z-index: 2;
}
.timeline-item.highlight::before { border-color: #000; background: #000; transform: scale(1.2); } /* Highlight current */

.card { 
    background-color: var(--bg-card); border-radius: 16px; padding: 20px; 
    box-shadow: var(--shadow); cursor: pointer; position: relative; 
    transition: transform 0.1s; border: 1px solid transparent;
}
.card:active { transform: scale(0.98); background: #F2F2F7; }
.timeline-item.highlight .card { border: 1px solid #000; }

.card-time { font-size: 0.8rem; color: var(--text-sub); font-weight: 600; margin-bottom: 4px; display: block; }
.card-title { font-size: 1.15rem; font-weight: 700; margin: 0 0 10px 0; padding-right: 35px; line-height: 1.3; }
.tags { display: flex; gap: 6px; flex-wrap: wrap; }
.card-tag { font-size: 0.7rem; background: #F2F2F7; padding: 4px 10px; border-radius: 6px; color: #666; font-weight: 500; }
.card-nav-btn { 
    position: absolute; top: 20px; right: 20px; width: 36px; height: 36px; border-radius: 50%; 
    background: #F2F2F7; color: #000; display: flex; justify-content: center; align-items: center; 
    font-size: 1rem; transition: background 0.2s; z-index: 5; 
}

/* --- Weather --- */
.weather-main-card {
    background: linear-gradient(135deg, #2c3e50, #000000);
    color: white; border-radius: 20px; padding: 30px 25px;
    margin: 0 20px 20px 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    text-align: center; position: relative; overflow: hidden;
}
.weather-date { font-size: 0.95rem; opacity: 0.8; margin-bottom: 5px; font-weight: 600; letter-spacing: 0.5px; }
.weather-icon-lg { font-size: 4.5rem; margin: 10px 0; text-shadow: 0 4px 10px rgba(0,0,0,0.3); }
.weather-temp-lg { font-size: 4rem; font-weight: 300; letter-spacing: -2px; margin: 5px 0; }
.weather-desc { font-size: 1.2rem; margin-bottom: 20px; font-weight: 500; }
.weather-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 0 20px; }
.weather-stat-card {
    background: #FFF; padding: 15px; border-radius: 16px; border: 1px solid rgba(0,0,0,0.05);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.02);
}
.ws-icon { font-size: 1.2rem; color: #666; margin-bottom: 6px; }
.ws-label { font-size: 0.7rem; color: #8E8E93; text-transform: uppercase; letter-spacing: 0.5px; }
.ws-value { font-size: 1.1rem; font-weight: 700; margin-top: 4px; color: #333; }

/* --- Shopping --- */
.shopping-list { padding: 0 20px; }
.shop-item { 
    background: #FFF; padding: 16px; border-radius: 12px; margin-bottom: 10px;
    display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    transition: all 0.2s;
}
.shop-item.checked { opacity: 0.5; background: #F9F9F9; }
.shop-item.checked label { text-decoration: line-through; }
.shop-item input[type="checkbox"] { width: 22px; height: 22px; accent-color: #000; cursor: pointer; }
.shop-item label { flex: 1; font-size: 1rem; cursor: pointer; }

/* --- Phrases --- */
.phrase-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 0 20px; }
.phrase-card { 
    background: #FFF; border: 1px solid var(--border); padding: 20px 15px; border-radius: 16px; 
    text-align: center; cursor: pointer; transition: all 0.2s; 
    box-shadow: var(--shadow); aspect-ratio: 1.3; 
    display: flex; flex-direction: column; justify-content: center; align-items: center; 
}
.phrase-card:active { transform: scale(0.96); background: #F5F5F5; }
.phrase-jp { font-weight: 700; font-size: 1.2rem; margin-bottom: 8px; color: #000; }
.phrase-zh { font-size: 0.85rem; color: #8E8E93; }
.phrase-overlay { 
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(255,255,255,0.98); z-index: 5000; 
    display: flex; justify-content: center; align-items: center; 
    opacity: 0; pointer-events: none; transition: opacity 0.3s; 
}
.phrase-overlay.active { opacity: 1; pointer-events: all; }
.phrase-content { text-align: center; width: 90%; transform: rotate(0deg); }
/* Landscape mode for phrase card for better visibility */
.phrase-big { font-size: 3.5rem; font-weight: 800; color: #000; line-height: 1.2; margin-bottom: 20px; word-break: break-all; }
.phrase-sub { font-size: 1.5rem; color: #666; }
.close-phrase { 
    position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); 
    border: 1px solid #E5E5EA; padding: 12px 40px; border-radius: 30px; 
    color: #000; cursor: pointer; background: #FFF; font-weight: 600; 
    box-shadow: 0 5px 20px rgba(0,0,0,0.1); 
}

/* --- Modal --- */
.modal { 
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(0,0,0,0.5); z-index: 3000; justify-content: center; align-items: end; 
    backdrop-filter: blur(4px); cursor: pointer; 
}
.modal.open { display: flex; }
.modal-content { 
    background: #FFF; color: #000; width: 100%; max-width: 600px; max-height: 90vh; 
    border-radius: 24px 24px 0 0; padding: 0 0 40px 0; overflow-y: auto; 
    animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); cursor: default; 
    display: flex; flex-direction: column; position: relative;
}
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
#modal-mini-map { width: 100%; height: 220px; background: #EEE; flex-shrink: 0; }
.modal-body { padding: 25px; }
.modal-header-row { margin-bottom: 20px; }
.modal-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
.modal-label { font-size: 0.7rem; color: #8E8E93; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 6px; font-weight: 600; }
.modal-value { font-size: 1rem; font-weight: 500; color: #1C1C1E; }
.modal-note-box { background: #F2F2F7; padding: 20px; border-radius: 12px; margin: 15px 0; }
.modal-note-content { font-size: 0.95rem; line-height: 1.6; white-space: pre-line; color: #333; }
.modal-actions { margin-top: 25px; display: flex; flex-direction: column; gap: 12px;}
.btn-action { 
    width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: 600; 
    cursor: pointer; font-size: 1rem; text-align: center; transition: transform 0.1s;
}
.btn-action:active { transform: scale(0.98); }
.btn-black { background: #000; color: #FFF; }
.btn-outline { background: #FFF; border: 1px solid #E5E5EA; color: #000; }
.close-modal-btn { 
    position: absolute; top: 15px; right: 15px; width: 36px; height: 36px; 
    background: rgba(255,255,255,0.8); border-radius: 50%; display: flex; 
    justify-content: center; align-items: center; cursor: pointer; z-index: 4000; 
    font-size: 1.2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

/* --- Bottom Nav --- */
nav.bottom-nav { 
    position: fixed; bottom: 0; width: 100%; background-color: rgba(255,255,255,0.95); 
    display: flex; justify-content: space-around; padding: 10px 0 calc(10px + var(--safe-area-bottom)) 0; 
    border-top: 1px solid var(--border); z-index: 100; backdrop-filter: blur(10px);
}
.nav-item { color: #C7C7CC; text-align: center; font-size: 0.65rem; cursor: pointer; width: 25%; transition: color 0.2s; }
.nav-item i { display: block; font-size: 1.4rem; margin-bottom: 4px; }
.nav-item.active { color: var(--accent-black); }

/* --- Info Page Helpers --- */
.info-card { background: #FFF; padding: 20px; border-radius: 16px; margin: 0 20px 15px 20px; border: 1px solid var(--border); box-shadow: var(--shadow); }
.info-row { display: flex; gap: 15px; margin-bottom: 15px; align-items: flex-start; font-size: 0.95rem; color: #333; }
.info-icon { width: 24px; text-align: center; color: var(--text-sub); }
.contact-container { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-top: 6px; }
.btn-icon-sm { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; text-decoration: none; font-size: 1rem; cursor: pointer; transition: transform 0.1s; }
.btn-call { background: #E8F5E9; color: #2E7D32; border: 1px solid #C8E6C9; }
.btn-wa { background: #25D366; color: white; border: 1px solid #20bd5a; }

/* Filter Chips */
.filter-bar-container { padding: 0 20px 15px 20px; position: sticky; top: 0; z-index: 50; background: var(--bg-body); overflow-x: auto; white-space: nowrap; scrollbar-width: none; }
.filter-chip { display: inline-block; padding: 8px 18px; margin-right: 8px; background: #FFF; border: 1px solid #E5E5EA; border-radius: 20px; font-size: 0.9rem; color: #666; cursor: pointer; transition: all 0.2s; }
.filter-chip.active { background: #000; color: #FFF; border-color: #000; }
.inspire-card { background: #FFF; border: 1px solid #E5E5EA; border-radius: 12px; padding: 20px; color: #444; position: relative; display: block; margin-bottom: 0;}
.inspire-card.hidden { display: none; }
.inspire-badge { background: #000; color: #fff; padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: bold; position: absolute; top: -10px; left: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
</style>
</head>
<body>

<div id="toast"><i class="fa-solid fa-circle-check"></i> <span id="toast-msg">Action Completed</span></div>

<header>
    <h1>KYOTO <span style="font-weight:300; opacity:0.5;">2026</span></h1>
    <div class="header-actions">
        <div class="header-btn" onclick="openTranslate()" title="Google Translate"><i class="fa-solid fa-language"></i></div>
        <div class="header-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></div>
    </div>
</header>

<div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
<div class="sidebar" id="sidebar">
    <div class="whatsapp-box">
        <div style="font-weight:bold; margin-bottom:5px;"><i class="fa-brands fa-whatsapp"></i> ÂÆâÂÖ® Check-in</div>
        <p style="font-size:0.8rem; color:#1B5E20; margin:0 0 10px 0;">ÁôºÈÄÅ‰Ω†ÁöÑÂç≥ÊôÇ Google Maps ÂÆö‰ΩçÁµ¶ÂÆ∂‰∫∫„ÄÇ</p>
        <input type="tel" id="wa-phone" class="wa-input" placeholder="Â∞çÊñπÈõªË©± (Â¶Ç 85291234567)">
        <button class="wa-btn" id="wa-btn" onclick="sendWhatsApp()"><i class="fa-solid fa-paper-plane"></i> ÁôºÈÄÅ‰ΩçÁΩÆ</button>
    </div>

    <div class="sidebar-section-title">Utilities</div>
    <div class="tool-box">
        <div style="font-weight:bold; margin-bottom:15px;"><i class="fa-solid fa-coins"></i> ÂåØÁéáË®àÁÆó (JPY ‚áÑ HKD)</div>
        <div class="currency-grid">
            <div class="curr-group"><span class="curr-label">JPY</span><input type="number" id="curr-jpy" class="curr-input" placeholder="0" oninput="convertCurrency()"></div>
            <div class="curr-icon"><i class="fa-solid fa-right-left"></i></div>
            <div class="curr-group"><span class="curr-label">HKD</span><input type="number" id="curr-hkd" class="curr-input" placeholder="0" readonly></div>
        </div>
        <div class="rate-info-container">
            <div id="rate-status" class="rate-status"><i class="fa-solid fa-circle-notch fa-spin"></i> ËºâÂÖ•‰∏≠...</div>
            <div class="rate-actions">
                <span class="rate-btn-text" onclick="fetchRates(true)">Âà∑Êñ∞</span>
                <span class="rate-btn-text" onclick="editRate()">ÊâãÂãï</span>
            </div>
        </div>
    </div>
    
    <div class="tool-box">
        <div style="font-weight:bold; margin-bottom:10px;"><i class="fa-solid fa-pen"></i> ÊóÖË°åÈö®ÊâãË®ò</div>
        <textarea id="quick-memo" class="memo-area" placeholder="ÊàøËôü„ÄÅWifiÂØÜÁ¢º„ÄÅÊèêÈÜí‰∫ãÈ†Ö..." oninput="saveMemo()"></textarea>
    </div>
</div>

<div id="phrase-overlay" class="phrase-overlay" onclick="closePhrase()">
    <div class="phrase-content">
        <div id="overlay-jp" class="phrase-big"></div>
        <div id="overlay-zh" class="phrase-sub"></div>
    </div>
    <div class="close-phrase">ÈªûÊìäÈóúÈñâ</div>
</div>

<div class="date-selector-container">
    <div class="date-selector" id="date-selector"></div>
</div>

<main>
    <div id="page-itinerary" class="page active">
        <div class="timeline-container" id="timeline-container"></div>
    </div>

    <div id="page-inspiration" class="page">
        <div class="filter-bar-container">
            <span class="filter-chip active" onclick="filterInspiration('all', this)">ÂÖ®ÈÉ®</span>
            <span class="filter-chip" onclick="filterInspiration('RAINY', this)">‚òî Èõ®Â§©</span>
            <span class="filter-chip" onclick="filterInspiration('TIRED', this)">‚òï ‰ºëÊÅØ</span>
            <span class="filter-chip" onclick="filterInspiration('LATE', this)">üåô Ê∑±Â§ú</span>
            <span class="filter-chip" onclick="filterInspiration('PHOTO', this)">üì∑ ÊãçÁÖß</span>
        </div>
        <div id="inspiration-container" class="inspiration-grid"></div>
    </div>

    <div id="page-shopping" class="page">
        <div class="page-header"><h2 class="page-title">Ë≥ºÁâ©Ê∏ÖÂñÆ</h2></div>
        <div style="padding:0 20px 10px 20px; font-size:0.85rem; color:#888;">ÂãæÈÅ∏ÂæåÊúÉËá™ÂãïË®òÊÜ∂</div>
        <div id="shopping-container" class="shopping-list"></div>
    </div>

    <div id="page-weather" class="page">
        <div id="weather-content">
            <div style="text-align:center; padding:50px; opacity:0.5;"><i class="fa-solid fa-spinner fa-spin fa-2x"></i><p>ËºâÂÖ•Â§©Ê∞£‰∏≠...</p></div>
        </div>
        <div class="weather-notice" id="weather-notice" style="text-align:center; color:#888; font-size:0.8rem; padding:20px;"></div>
    </div>

    <div id="page-info" class="page">
        <div class="page-header"><h2 class="page-title">ÊóÖÁ®ãË≥áË®ä</h2></div>
        
        <div class="info-card">
            <div style="font-weight:bold; margin-bottom:15px; border-bottom:1px solid #F0F0F0; padding-bottom:10px;">‰ΩèÂÆøË≥áË®ä</div>
            <div class="info-row">
                <div class="info-icon"><i class="fa-solid fa-hotel"></i></div>
                <div><span class="info-label">ÈÖíÂ∫ó</span><div class="modal-value">Dormy Inn Premium Kyoto</div></div>
            </div>
            <div class="info-row">
                <div class="info-icon"><i class="fa-solid fa-location-dot"></i></div>
                <div>
                    <span class="info-label">Âú∞ÂùÄ</span>
                    <div style="margin-bottom:8px;">‰∫¨ÈÉΩÂ∏Ç‰∏ã‰∫¨ÂçÄÊù±Â°©Â∞èË∑ØÁî∫ 558-8</div>
                    <div style="display:flex; gap:10px;">
                        <button class="nav-link" style="border:1px solid #DDD; background:#FFF; padding:6px 12px;" onclick="copyToClipboard('‰∫¨ÈÉΩÂ∏Ç‰∏ã‰∫¨ÂçÄÊù±Â°©Â∞èË∑ØÁî∫ 558-8')">Ë§áË£Ω</button>
                        <button class="nav-link" style="background:#000; color:#FFF; padding:6px 12px;" onclick="openMapQuery('Dormy Inn Premium Kyoto')">Â∞éËà™</button>
                    </div>
                </div>
            </div>
            <div class="info-row">
                <div class="info-icon"><i class="fa-solid fa-phone"></i></div>
                <div>
                    <span class="info-label">ÈõªË©±</span>
                    <div class="contact-container">
                        <span class="info-value" style="margin-right:10px;">+81-75-371-5489</span>
                        <a href="javascript:void(0)" onclick="callNumber('+81753715489')" class="btn-icon-sm btn-call" title="Êí•ÊâìÈõªË©±"><i class="fa-solid fa-phone"></i></a>
                    </div>
                </div>
            </div>
        </div>

        <div class="phrase-grid">
            <div class="phrase-card" onclick="showPhrase('‰∏Ä‰∫∫„Åß„Åô', 'ÊàëÊòØ‰∏Ä‰Ωç')"><div class="phrase-jp">‰∏Ä‰∫∫„Åß„Åô</div><div class="phrase-zh">‰∏Ä‰Ωç</div></div>
            <div class="phrase-card" onclick="showPhrase('„Åä‰ºöË®à„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô', 'È∫ªÁÖ©ÁµêÂ∏≥')"><div class="phrase-jp">„Åä‰ºöË®à</div><div class="phrase-zh">ÁµêÂ∏≥</div></div>
            <div class="phrase-card" onclick="showPhrase('„Åì„Çå„Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô', 'ÊàëË¶ÅÈÄôÂÄã')"><div class="phrase-jp">„Åì„Çå„Çí...</div><div class="phrase-zh">ÊàëË¶ÅÈÄôÂÄã</div></div>
            <div class="phrase-card" onclick="showPhrase('„Éà„Ç§„É¨„ÅØ„Å©„Åì„Åß„Åô„Åã', 'Ê¥óÊâãÈñìÂú®Âì™Ë£°Ôºü')"><div class="phrase-jp">„Éà„Ç§„É¨</div><div class="phrase-zh">Ê¥óÊâãÈñì</div></div>
        </div>
    </div>
</main>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchMainPage('itinerary', this)"><i class="fa-regular fa-calendar-days"></i><span>Ë°åÁ®ã</span></div>
    <div class="nav-item" onclick="switchMainPage('inspiration', this)"><i class="fa-regular fa-compass"></i><span>ÈùàÊÑü</span></div>
    <div class="nav-item" onclick="switchMainPage('shopping', this)"><i class="fa-solid fa-bag-shopping"></i><span>Êé°Ë≤∑</span></div>
    <div class="nav-item" onclick="switchMainPage('weather', this)"><i class="fa-solid fa-cloud-sun"></i><span>Â§©Ê∞£</span></div>
    <div class="nav-item" onclick="switchMainPage('info', this)"><i class="fa-solid fa-sliders"></i><span>Ë≥áË®ä</span></div>
</nav>

<div id="detail-modal" class="modal">
    <div class="modal-content">
        <div class="close-modal-btn" onclick="closeModal()">√ó</div>
        <div id="modal-mini-map"></div>
        
        <div class="modal-body">
            <div class="modal-header-row">
                <span class="modal-label" id="modal-type">Type</span>
                <h2 id="modal-title" style="margin:0; font-size:1.6rem; letter-spacing:-0.5px;">Title</h2>
            </div>

            <div class="modal-info-grid">
                <div><span class="modal-label">ÊôÇÈñì</span><span class="modal-value" id="modal-time"></span></div>
                <div><span class="modal-label">È†êÁÆó</span><span class="modal-value" id="modal-price"></span></div>
                <div><span class="modal-label">ÈñãÊîæÊôÇÈñì</span><span class="modal-value" id="modal-open-hours"></span></div>
                <div>
                    <span class="modal-label">Âú∞ÂùÄ</span>
                    <span class="modal-value" id="modal-address-short" style="font-size:0.9rem;"></span>
                </div>
            </div>

            <div class="modal-label">ÂÇôË®ªËàáÊîªÁï•</div>
            <div class="modal-note-box"><div id="modal-note" class="modal-note-content"></div></div>

            <div class="modal-actions" id="modal-actions"></div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// --- SCHEDULE DATA (2026 Sample) ---
const scheduleData = {
    "day1": { "date": "2026-01-07", "display": "07", "weekday": "ÈÄ±‰∏â", "events": [ 
        { time: "14:00", title: "Check-in: Dormy Inn", type: "‰ΩèÂÆø", price: "-", open_hours: "24H", address: "Dormy Inn Premium Kyoto", address_jp: "‰∫¨ÈÉΩÂ∏Ç‰∏ã‰∫¨Âå∫Êù±Â°©Â∞èË∑ØÁî∫558-8", coords: [34.9868, 135.7599], note: "Ê©üÂ†¥Â∑¥Â£´Áõ¥ÈÅî‰∫¨ÈÉΩÁ´ôÂÖ´Ê¢ùÂè£ÔºåÊ≠•Ë°å3ÂàÜÈêò„ÄÇ\nÊúâÂÖçË≤ªÂÆµÂ§úÊãâÈ∫µ (21:30~)„ÄÇ", tags: ["ÁßªÂãï"] },
        { time: "16:00", title: "‰∫¨ÈÉΩÂ°î", type: "ÊôØÈªû", price: "¬•800", open_hours: "10-21", address: "Kyoto Tower", address_jp: "‰∫¨ÈÉΩ„Çø„ÉØ„Éº", coords: [34.9875, 135.7594], note: "ÁúãÊó•ËêΩÁöÑÂ•ΩÂú∞Êñπ„ÄÇ", tags: ["Âú∞Ê®ô"] } 
    ], "inspiration": [{title:"Èõ®Â§©ÔºöAEON Mall", tag:"RAINY", note:"‰∫¨ÈÉΩÁ´ôÂæåÁ´ôÔºåË∂ÖÂ§ßË≥ºÁâ©‰∏≠ÂøÉÔºåÊúâË∂ÖÂ∏Ç„ÄÇ"}, {title:"Â§úÊôöÔºö‰∫¨ÈÉΩËªäÁ´ôÂ§ßÈöéÊ¢Ø", tag:"PHOTO", note:"Êôö‰∏äÊúâÊµÅÊ∞¥ÁáàÂÖâÁßÄÔºåÊ∞£Ê∞õÂæàÂ•Ω„ÄÇ"}], "shopping": ["ICOCA Âç°", "7-11 ÁÇ∏Èõû"] },
    
    "day2": { "date": "2026-01-08", "display": "08", "weekday": "ÈÄ±Âõõ", "events": [ 
        { time: "09:00", title: "Ogawa Coffee", type: "ÁæéÈ£ü", price: "¬•1,200", open_hours: "07-21", address: "Ogawa Coffee Kyoto Station", address_jp: "Â∞èÂ∑ùÁèàÁê≤ ‰∫¨ÈÉΩÈßÖÂ∫ó", coords: [34.9852, 135.7584], note: "‰∫¨ÈÉΩËÄÅÁâåÂíñÂï°ÔºåÊé®Ëñ¶ÂéöÁâáÂêêÂè∏Êó©È§ê„ÄÇ", tags: ["ÂíñÂï°"] },
        { time: "11:00", title: "Èå¶Â∏ÇÂ†¥", type: "ÈÄõË°ó", price: "¬•3,000", open_hours: "10-18", address: "Nishiki Market", address_jp: "Èå¶Â∏ÇÂ†¥", coords: [35.0050, 135.7631], note: "ÈÇäËµ∞ÈÇäÂêÉÔºåÊ≥®ÊÑè‰∏çË¶ÅÊìãË∑Ø„ÄÇ", tags: ["Â∏ÇÈõÜ"] }
    ], "inspiration": [], "shopping": ["ÊäπËå∂Á≤â", "‰∫¨ÈÉΩÈôêÂÆöÂèØÊ®Ç"] },
    
    "day3": { "date": "2026-01-09", "display": "09", "weekday": "ÈÄ±‰∫î", "events": [], "inspiration": [], "shopping": [] },
    "day4": { "date": "2026-01-10", "display": "10", "weekday": "ÈÄ±ÂÖ≠", "events": [], "inspiration": [], "shopping": [] },
    "day5": { "date": "2026-01-11", "display": "11", "weekday": "ÈÄ±Êó•", "events": [], "inspiration": [], "shopping": [] },
    "day6": { "date": "2026-01-12", "display": "12", "weekday": "ÈÄ±‰∏Ä", "events": [], "inspiration": [], "shopping": [] },
    "day7": { "date": "2026-01-13", "display": "13", "weekday": "ÈÄ±‰∫å", "events": [], "inspiration": [], "shopping": [] }
};

let currentDay = "day1";
let modalMap = null;
let currentEventData = null;
let exchangeRate = 0.053; 
let weatherCache = null;
let shopState = {}; // Store shopping list state

function init() { 
    renderDateSelector(); 
    selectDay('day1'); 
    switchMainPage('itinerary', document.querySelector('.nav-item.active'));
    fetchRates(); 
    fetchWeather();
    
    // Load persisted data
    if(localStorage.getItem('travelMemo')) document.getElementById('quick-memo').value = localStorage.getItem('travelMemo');
    if(localStorage.getItem('shopState')) shopState = JSON.parse(localStorage.getItem('shopState'));
    
    // Auto-save memo
    document.getElementById('quick-memo').addEventListener('input', function() {
        localStorage.setItem('travelMemo', this.value);
    });
}

function showToast(msg) {
    const t = document.getElementById('toast');
    document.getElementById('toast-msg').innerText = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2000);
}

// --- CURRENCY ---
async function fetchRates(force = false) {
    const statusEl = document.getElementById('rate-status');
    statusEl.innerHTML = '<i class="fa-solid fa-sync fa-spin"></i> Êõ¥Êñ∞‰∏≠...';

    const cachedRate = localStorage.getItem('cachedRate');
    const cachedTime = localStorage.getItem('cachedRateTime');
    const now = new Date().getTime();

    if (!force && cachedRate && cachedTime && (now - cachedTime < 12 * 60 * 60 * 1000)) {
        exchangeRate = parseFloat(cachedRate);
        const dateObj = new Date(parseInt(cachedTime));
        updateRateUI(exchangeRate, `${dateObj.getMonth()+1}/${dateObj.getDate()}`, true);
        return;
    }

    try {
        const res = await fetch('https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/jpy.json');
        const data = await res.json();
        if(data.jpy && data.jpy.hkd) {
            exchangeRate = data.jpy.hkd;
            localStorage.setItem('cachedRate', exchangeRate);
            localStorage.setItem('cachedRateTime', now);
            updateRateUI(exchangeRate, 'ÂâõÂâõ', true);
            convertCurrency();
            if(force) showToast("ÂåØÁéáÂ∑≤Êõ¥Êñ∞");
        }
    } catch(e) { 
        console.error(e);
        if(cachedRate) {
            exchangeRate = parseFloat(cachedRate);
            updateRateUI(exchangeRate, 'Èõ¢Á∑ö', false);
        } else {
            updateRateUI(exchangeRate, 'È†êË®≠', false);
        }
    }
}

function updateRateUI(rate, dateLabel, isSuccess) {
    const statusEl = document.getElementById('rate-status');
    const color = isSuccess ? '#2E7D32' : 'orange';
    statusEl.innerHTML = `<span style="color:${color}; font-weight:600;">HKD 1 = JPY ${(1/rate).toFixed(1)}</span> <span style="color:#AAA;">(${dateLabel})</span>`;
}

function convertCurrency() {
    const jpy = parseFloat(document.getElementById('curr-jpy').value);
    if(!isNaN(jpy)) { document.getElementById('curr-hkd').value = (jpy * exchangeRate).toFixed(1); } else { document.getElementById('curr-hkd').value = ""; }
}

function editRate() {
    const newRate = prompt("ÊâãÂãïË®≠ÂÆöÂåØÁéá (‰æãÂ¶Ç 0.053):", exchangeRate);
    if(newRate && !isNaN(newRate)) { 
        exchangeRate = parseFloat(newRate); 
        updateRateUI(exchangeRate, 'ÊâãÂãï', false);
        convertCurrency(); 
    }
}

// --- WEATHER ---
async function fetchWeather() {
    const lat = 35.0116; const lon = 135.7681; // Kyoto
    try {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max,sunrise,sunset,uv_index_max&timezone=auto&forecast_days=16`;
        const res = await fetch(url);
        weatherCache = await res.json();
    } catch(e) { console.error("Weather Error", e); }
}

function renderWeatherModule() {
    const container = document.getElementById('weather-content');
    const noticeEl = document.getElementById('weather-notice');
    if(!weatherCache || !weatherCache.daily) { container.innerHTML = "<div style='text-align:center; padding:30px;'>ÁÑ°Â§©Ê∞£Ë≥áÊñô (Ë´ãÁ¢∫Ë™çÁ∂≤Ë∑Ø)</div>"; return; }

    const targetDate = scheduleData[currentDay].date; 
    const apiIndex = weatherCache.daily.time.indexOf(targetDate);

    if (apiIndex === -1) {
        container.innerHTML = `<div style='text-align:center; padding:40px; color:#666;'><i class="fa-regular fa-calendar-xmark fa-2x"></i><br>Â∞öÁÑ° ${scheduleData[currentDay].display} ËôüÁöÑÂ§©Ê∞£È†êÂ†±</div>`;
        noticeEl.style.display = 'none';
        return;
    }

    const d = weatherCache.daily;
    const code = d.weathercode[apiIndex];
    const wmo = { 0:{i:'fa-sun',t:'Êô¥Êúó',c:'#F1C40F'}, 1:{i:'fa-cloud-sun',t:'Â§öÈõ≤',c:'#F39C12'}, 2:{i:'fa-cloud-sun',t:'Â§öÈõ≤',c:'#F39C12'}, 3:{i:'fa-cloud',t:'Èô∞Â§©',c:'#95A5A6'}, 45:{i:'fa-smog',t:'Èúß',c:'#95A5A6'}, 51:{i:'fa-cloud-rain',t:'ÊØõÊØõÈõ®',c:'#3498DB'}, 53:{i:'fa-cloud-rain',t:'Â∞èÈõ®',c:'#3498DB'}, 61:{i:'fa-cloud-showers-heavy',t:'Èô£Èõ®',c:'#2980B9'}, 80:{i:'fa-cloud-showers-water',t:'Èõ∑Èô£Èõ®',c:'#8E44AD'}, 95:{i:'fa-bolt',t:'Èõ∑Èõ®',c:'#8E44AD'} };
    const w = wmo[code] || {i:'fa-cloud',t:'Êú™Áü•',c:'#CCC'};

    container.innerHTML = `
    <div class="weather-main-card">
        <div class="weather-date">${scheduleData[currentDay].date} ‚Ä¢ Kyoto</div>
        <div class="weather-icon-lg" style="color:${w.c}"><i class="fa-solid ${w.i}"></i></div>
        <div class="weather-temp-lg">${Math.round(d.temperature_2m_max[apiIndex])}¬∞</div>
        <div class="weather-desc">${w.t} / ‰ΩéÊ∫´ ${Math.round(d.temperature_2m_min[apiIndex])}¬∞</div>
    </div>
    <div class="weather-grid">
        <div class="weather-stat-card"><i class="fa-solid fa-umbrella ws-icon"></i><span class="ws-label">ÈôçÈõ®Ê©üÁéá</span><span class="ws-value">${d.precipitation_probability_max[apiIndex]}%</span></div>
        <div class="weather-stat-card"><i class="fa-solid fa-sun ws-icon"></i><span class="ws-label">Á¥´Â§ñÁ∑ö</span><span class="ws-value">${d.uv_index_max[apiIndex]}</span></div>
        <div class="weather-stat-card"><i class="fa-regular fa-clock ws-icon"></i><span class="ws-label">Êó•Âá∫</span><span class="ws-value">${d.sunrise[apiIndex].split('T')[1]}</span></div>
        <div class="weather-stat-card"><i class="fa-solid fa-moon ws-icon"></i><span class="ws-label">Êó•ËêΩ</span><span class="ws-value">${d.sunset[apiIndex].split('T')[1]}</span></div>
    </div>`;
    noticeEl.innerText = `Ë≥áÊñô‰æÜÊ∫ê: Open-Meteo (Êõ¥Êñ∞Êñº: ${new Date().toLocaleTimeString()})`;
    noticeEl.style.display = 'block';
}

// --- UTILS ---
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('sidebar-overlay').classList.toggle('open'); }
function openTranslate() { window.open("https://translate.google.com/?sl=auto&tl=zh-TW", "_blank"); }

function navigateTo(pageId) {
    toggleSidebar();
    switchMainPage(pageId);
}

function switchMainPage(pageId, navEl) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-' + pageId).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    if(navEl) navEl.classList.add('active');
    
    const ds = document.querySelector('.date-selector-container');
    // Hide date selector on Info page
    if(pageId === 'info') ds.style.display = 'none'; 
    else ds.style.display = 'block';
    
    if(pageId === 'weather') renderWeatherModule();
}

function sendWhatsApp() {
    let phone = document.getElementById('wa-phone').value.replace(/\D/g, '');
    if(!phone) { alert("Ë´ãËº∏ÂÖ•Â∞çÊñπÈõªË©±ËôüÁ¢º"); return; }
    
    if (navigator.geolocation) {
        // Show simple loading state
        const btn = document.getElementById('wa-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ÂÆö‰Ωç‰∏≠...';
        
        navigator.geolocation.getCurrentPosition((pos) => {
            // FIX: Standard Google Maps Coordinates Link
            const mapLink = `https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
            const text = `ÊàëÁèæÂú®Âú®ÈÄôË£°Ôºå‰∏ÄÂàáÂπ≥ÂÆâÔºÅ\n${mapLink}`;
            const url = `https://wa.me/${phone}?text=${encodeURIComponent(text)}`;
            window.location.href = url;
            btn.innerHTML = originalText;
        }, (err) => {
            alert("ÁÑ°Ê≥ïÁç≤Âèñ‰ΩçÁΩÆÔºåË´ãÊ™¢Êü•ÁÄèË¶ΩÂô®Ê¨äÈôê");
            btn.innerHTML = originalText;
        });
    } else alert("ÁÄèË¶ΩÂô®‰∏çÊîØÊè¥ÂÆö‰Ωç");
}

function callNumber(num) { window.location.href = `tel:${num}`; }
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => { showToast("Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø"); });
}
function showPhrase(jp, zh) { document.getElementById('overlay-jp').innerText = jp; document.getElementById('overlay-zh').innerText = zh; document.getElementById('phrase-overlay').classList.add('active'); }
function closePhrase() { document.getElementById('phrase-overlay').classList.remove('active'); }

// --- RENDERERS ---
function renderDateSelector() {
    const container = document.getElementById('date-selector'); container.innerHTML = '';
    Object.keys(scheduleData).forEach(dayKey => {
        const day = scheduleData[dayKey];
        const chip = document.createElement('div'); chip.className = `date-chip`;
        chip.id = `chip-${dayKey}`;
        chip.onclick = () => selectDay(dayKey, chip);
        chip.innerHTML = `<span class="day-num">${day.display}</span><span class="day-week">${day.weekday}</span>`;
        container.appendChild(chip);
    });
}

function selectDay(dayKey, chipEl) {
    currentDay = dayKey;
    document.querySelectorAll('.date-chip').forEach(c => c.classList.remove('active'));
    
    // Handle Auto-scroll for date selector
    const activeChip = chipEl || document.getElementById(`chip-${dayKey}`);
    if(activeChip) {
        activeChip.classList.add('active');
        activeChip.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    }

    renderTimeline(dayKey); 
    renderInspiration(dayKey); 
    renderShopping(dayKey);
    if(document.getElementById('page-weather').classList.contains('active')) renderWeatherModule();
}

function renderTimeline(dayKey) {
    const container = document.getElementById('timeline-container'); container.innerHTML = '';
    const events = scheduleData[dayKey].events || [];
    if(events.length === 0) { container.innerHTML = `<div style="text-align:center; padding:60px; color:#AAA;"><i class="fa-regular fa-face-smile" style="font-size:2rem; margin-bottom:10px;"></i><br>Ëá™Áî±Êé¢Á¥¢ÁöÑ‰∏ÄÂ§©</div>`; return; }
    
    events.forEach(event => {
        const item = document.createElement('div'); item.className = 'timeline-item';
        // Add logic to highlight current event? (Simplified: no real-time check for now)
        let tags = event.tags.map(t => `<span class="card-tag">${t}</span>`).join('');
        const navBtn = `<div class="card-nav-btn" onclick="event.stopPropagation(); openMapQuery('${event.address}')"><i class="fa-solid fa-location-arrow"></i></div>`;
        item.innerHTML = `<div class="card" onclick='openModal(${JSON.stringify(event).replace(/'/g, "&#39;")})'>${navBtn}<span class="card-time">${event.time}</span><h3 class="card-title">${event.title}</h3><div class="tags">${tags}</div></div>`;
        container.appendChild(item);
    });
}

function renderInspiration(dayKey) {
    const container = document.getElementById('inspiration-container'); container.innerHTML = '';
    (scheduleData[dayKey].inspiration || []).forEach(item => { 
        container.innerHTML += `<div class="inspire-card" data-tag="${item.tag}"><div class="inspire-badge">${item.tag}</div><h3>${item.title}</h3><p style="margin:5px 0 0 0; font-size:0.9rem; color:#666;">${item.note}</p></div>`; 
    });
    // Reset filters
    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
    document.querySelector('.filter-chip').classList.add('active');
}

function filterInspiration(tag, btn) {
    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active')); btn.classList.add('active');
    document.querySelectorAll('.inspire-card').forEach(card => { 
        if(tag === 'all' || card.getAttribute('data-tag') === tag) card.classList.remove('hidden'); else card.classList.add('hidden'); 
    });
}

function renderShopping(dayKey) {
    const container = document.getElementById('shopping-container'); container.innerHTML = '';
    const items = scheduleData[dayKey].shopping || [];
    if(items.length === 0) { container.innerHTML = "<div style='color:#AAA; text-align:center; padding:20px;'>ÁÑ°ÂæÖË≤∑Ê∏ÖÂñÆ</div>"; return; }
    
    items.forEach((item, idx) => {
        const uniqueId = `${dayKey}-${idx}`;
        const isChecked = shopState[uniqueId] ? 'checked' : '';
        const div = document.createElement('div');
        div.className = `shop-item ${isChecked ? 'checked' : ''}`;
        div.innerHTML = `<input type="checkbox" id="${uniqueId}" ${isChecked} onchange="toggleShopItem(this, '${uniqueId}')"><label for="${uniqueId}">${item}</label>`;
        container.appendChild(div);
    });
}

function toggleShopItem(checkbox, id) {
    shopState[id] = checkbox.checked;
    localStorage.setItem('shopState', JSON.stringify(shopState));
    checkbox.closest('.shop-item').classList.toggle('checked');
}

// --- MAP & MODAL ---
function openMapQuery(address) { 
    // FIX: Standard Google Maps Universal Link
    const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
    window.open(url, '_blank'); 
}

function openModal(data) {
    currentEventData = data;
    document.getElementById('modal-title').innerText = data.title;
    document.getElementById('modal-type').innerText = data.type;
    document.getElementById('modal-time').innerText = data.time;
    document.getElementById('modal-price').innerText = data.price;
    document.getElementById('modal-open-hours').innerText = data.open_hours || "ÂæÖÁ¢∫Ë™ç";
    document.getElementById('modal-address-short').innerText = data.address;
    document.getElementById('modal-note').innerText = data.note;
    
    const actionsContainer = document.getElementById('modal-actions');
    actionsContainer.innerHTML = '';
    
    // Copy Address Button
    const addr = data.address_jp || data.address;
    actionsContainer.innerHTML += `<button class="btn-action btn-outline" onclick="copyToClipboard('${addr}')"><i class="fa-regular fa-copy"></i> Ë§áË£ΩÂú∞ÂùÄ</button>`;
    
    // Nav Button
    actionsContainer.innerHTML += `<button class="btn-action btn-black" onclick="openMapQuery('${data.address}')"><i class="fa-solid fa-location-arrow"></i> Google Maps Â∞éËà™</button>`;
    
    // Contextual Button
    if (data.type === 'ÁæéÈ£ü') {
        actionsContainer.innerHTML += `<button class="btn-action btn-outline" onclick="searchGmail('${data.title}')">üîç ÊêúÂ∞ãÈ†êÁ¥Ñ‰ø° (Gmail)</button>`;
    } else if (data.type === '‰ΩèÂÆø') {
        actionsContainer.innerHTML += `<button class="btn-action btn-outline" onclick="showPhrase('${addr}', 'Ë´ãËºâÊàëÂéªÈÄôË£°')">üöï È°ØÁ§∫ÁöÑÂ£´Âç°</button>`;
    }

    document.getElementById('detail-modal').classList.add('open');

    // Mini Map initialization (Delay to allow modal render)
    setTimeout(() => { 
        if(modalMap) modalMap.remove(); 
        modalMap = L.map('modal-mini-map', {zoomControl:false, dragging:false, attributionControl: false}).setView(data.coords, 15); 
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(modalMap); 
        L.marker(data.coords, {icon: L.divIcon({className:'custom-div-icon',html:"<div style='background:black;width:12px;height:12px;border-radius:50%;border:2px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);'></div>",iconSize:[12,12]})}).addTo(modalMap); 
        modalMap.invalidateSize(); 
    }, 150);
}

function closeModal() { document.getElementById('detail-modal').classList.remove('open'); }
document.getElementById('detail-modal').addEventListener('click', function(e) { if (e.target === this) closeModal(); });
function searchGmail(query) { window.open(`https://mail.google.com/mail/u/0/#search/${encodeURIComponent(query)}`, '_blank'); }

init();
</script>
</body>
</html>
